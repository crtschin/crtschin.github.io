<!doctype html><html lang=en><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Haskell's ordered maps are fun tools to have in any arsenal. In this post I give an example on doing dependency resolution quickly using the partially ordered nature of dependency relations, using an extremely contrived example."><title>(Non-)Functional Ramblings - Can I pet your DAG?</title><style>@font-face{font-family:fira code;font-style:normal;font-weight:300 700;font-display:swap;src:local("Fira Code"),local("FiraCode"),url(/css/fonts/FiraCode-d757346.woff2)format('woff2-variations')}@font-face{font-family:montserrat;font-style:normal;font-weight:100 900;font-display:swap;src:local("Montserrat"),url(/css/fonts/Montserrat-d757346.woff2)format('woff2-variations')}@font-face{font-family:montserrat;font-style:italic;font-weight:100 900;font-display:swap;src:local("Montserrat Italic"),local("Montserrat-Italic"),url(/css/fonts/Montserrat-Italic-d757346.woff2)format('woff2-variations')}html{font-size:80%;font-weight:400;font-family:montserrat,arial,sans-serif;scroll-behavior:smooth;scrollbar-gutter:stable}html{text-size-adjust:none}*,*::before,*::after{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;-ms-box-sizing:border-box;-o-box-sizing:border-box;box-sizing:border-box}body{line-height:1.5;-webkit-font-smoothing:antialiased}input,button,textarea,select{font:inherit}p,h1,h2,h3,h4,h5,h6{overflow-wrap:break-word}#root,#__next{isolation:isolate}body{font-size:1.6rem;background-color:#282828;color:#fbf1c7}code,pre{background-color:#1d2021}header{border-bottom:.2rem solid #98971a}nav a{font-weight:700;text-decoration:none}body img{max-width:100%;max-height:100%;display:block;margin:auto;height:auto;width:auto}body figcaption{text-align:center}footer{margin-top:3rem;padding:1.2rem 0;border-top:.2rem solid #98971a;font-size:1.2rem;color:#fbf1c7}h1{font-size:2.4rem}h2{font-size:2rem}h3{font-size:1.8rem}h4{font-size:1.6rem}.title{margin-bottom:0}article .publish-date{margin:0 0 2rem 1rem;font-size:1.4rem;color:#fbf1c7}article .last-modified-date{font-size:1rem}.logo a{font-weight:700;color:#fbf1c7;text-decoration:none}html{scrollbar-width:thick;scrollbar-color:#928374 #282828}pre{scrollbar-width:thin;scrollbar-color:#928374 #282828}nav.toc{float:left;clear:left;font-size:2rem;margin-left:-28%;width:20rem;word-wrap:break-word;padding:1rem;vertical-align:baseline;position:-webkit-sticky;position:sticky;top:5vh}nav.toc a{font-size:1.4rem}nav.toc ::marker{margin:0 -1rem 0 0}nav.toc li{margin:0;padding:0;line-height:1.2}nav.toc .toc-header{font-weight:700}nav.toc ul li{list-style-position:outside}nav.toc ul{margin-top:0;margin-bottom:0}pre,code{width:100%;font-family:fira code,consolas,monospace}div.highlight.inline{display:inline}pre{white-space:pre;overflow:auto;margin:1rem 0;background-color:#1d2021;padding:1rem;border-radius:.5rem .5rem .5rem .5rem}code{word-break:break-word;padding:0 .4rem;border-radius:.3rem .3rem .3rem .3rem}html a:link{color:#689d6a;background-color:initial;text-decoration:underline}html a:visited{color:#689d6a;background-color:initial;text-decoration:underline}html a:hover{color:#8ec07c;background-color:initial;text-decoration:underline}html a:active{color:#8ec07c;background-color:initial;text-decoration:none}nav.header a:link{color:#689d6a;background-color:initial;text-decoration:none}nav.header a:visited{color:#689d6a;background-color:initial;text-decoration:none}nav.header a:hover{color:#8ec07c;background-color:initial;text-decoration:none}nav.header a:active{color:#8ec07c;background-color:initial;text-decoration:underline}nav.toc a:link{color:#689d6a;background-color:initial;text-decoration:none}nav.toc a:visited{color:#689d6a;background-color:initial;text-decoration:none}nav.toc a:hover{color:#8ec07c;background-color:initial;text-decoration:none}nav.toc a:active{color:#8ec07c;background-color:initial;text-decoration:underline}.sidenote,marginnote{width:20rem;clear:right;font-size:1.1rem;line-height:1.3;vertical-align:baseline}body{counter-set:sidenote-counter}.sidenote-number{counter-increment:sidenote-counter}.sidenote:before{content:counter(sidenote-counter)" ";position:relative;vertical-align:baseline;font-weight:700;font-size:1rem;top:-.5rem;font-size:.9em}.sidenote-number:after{content:counter(sidenote-counter);position:relative;vertical-align:baseline;font-weight:700;font-size:1rem;top:-.5rem;left:.1rem}blockquote .sidenote,blockquote .marginnote{margin-right:82%;min-width:59%;text-align:left}.sidenote>code{font-size:1rem}label.sidenote-number{display:inline-block;max-height:2rem}label.margin-toggle:not(.sidenote-number){display:none}input.margin-toggle{display:none}.post-list-item{margin-top:.3rem}.post-description{padding-left:1rem}.post-footer-title{display:inline-block;margin:0;padding-left:3rem;text-align:left}.post-footer-date{float:right;margin:0;text-align:right}@media all and (max-width:1439px){nav.toc{display:none}}@media all and (max-width:1439px){.sidenote,.marginnote{float:right;text-align:left;margin:1rem 0;padding-left:5%}}@media all and (min-width:1440px){.sidenote,.marginnote{float:right;margin-right:-30%;margin-top:.3rem;margin-bottom:0;position:relative}}@media all and (max-width:639px){body{width:100%;margin:0;padding:0 5%}header{margin:1rem 0}nav.header{margin:.5rem auto;text-align:center}footer{text-align:center}nav.header a{font-size:1.4rem;line-height:1.6}.logo{font-size:1.8rem}nav.header a{margin:0 .6rem}}@media all and (min-width:640px){body{width:70rem;margin:0 auto;padding:0}header{margin:0 0 3rem;padding:.6rem 0 .2rem}nav.header{display:flex;align-items:flex-end;justify-content:space-between;margin:0;text-align:right}nav.header a{font-size:1.8rem;margin:0 0 0 .6rem;display:inline}.navigation{justify-content:flex-end}footer{text-align:right}.logo{margin:0;text-align:left;font-size:2.4rem}}pre{line-height:125%}td.linenos .normal{color:#3c4354;background-color:initial;padding-left:5px;padding-right:5px}span.linenos{color:#3c4354;background-color:initial;padding-left:5px;padding-right:5px}td.linenos .special{color:#3c4354;background-color:#ffffc0;padding-left:5px;padding-right:5px}span.linenos.special{color:#3c4354;background-color:#ffffc0;padding-left:5px;padding-right:5px}.hll{background-color:#6e7681}.c{color:#7e8aa1}.err{color:#f88f7f}.esc{color:#d4d2c8}.g{color:#d4d2c8}.k{color:#ffad66}.l{color:#d5ff80}.n{color:#d4d2c8}.o{color:#ffad66}.x{color:#d4d2c8}.p{color:#d4d2c8}.ch{color:#f88f7f;font-style:italic}.cm{color:#7e8aa1}.cp{color:#ffad66;font-weight:700}.cpf{color:#7e8aa1}.c1{color:#7e8aa1}.cs{color:#7e8aa1;font-style:italic}.gd{color:#f88f7f;background-color:#3d1e20}.ge{color:#d4d2c8;font-style:italic}.ges{color:#d4d2c8}.gr{color:#f88f7f}.gh{color:#d4d2c8}.gi{color:#6ad4af;background-color:#19362c}.go{color:#7e8aa1}.gp{color:#d4d2c8}.gs{color:#d4d2c8;font-weight:700}.gu{color:#d4d2c8}.gt{color:#f88f7f}.kc{color:#ffad66}.kd{color:#ffad66}.kn{color:#ffad66}.kp{color:#ffad66}.kr{color:#ffad66}.kt{color:#73d0ff}.ld{color:#d5ff80}.m{color:#dfbfff}.s{color:#d5ff80}.na{color:#ffd173}.nb{color:#ffd173}.nc{color:#73d0ff}.no{color:#ffd173}.nd{color:#7e8aa1;font-weight:700;font-style:italic}.ni{color:#95e6cb}.ne{color:#73d0ff}.nf{color:#ffd173}.nl{color:#d4d2c8}.nn{color:#d4d2c8}.nx{color:#d4d2c8}.py{color:#ffd173}.nt{color:#5ccfe6}.nv{color:#d4d2c8}.ow{color:#ffad66}.pm{color:#d4d2c8}.w{color:#d4d2c8}.mb{color:#dfbfff}.mf{color:#dfbfff}.mh{color:#dfbfff}.mi{color:#dfbfff}.mo{color:#dfbfff}.sa{color:#f29e74}.sb{color:#d5ff80}.sc{color:#d5ff80}.dl{color:#d5ff80}.sd{color:#7e8aa1}.s2{color:#d5ff80}.se{color:#95e6cb}.sh{color:#d5ff80}.si{color:#95e6cb}.sx{color:#95e6cb}.sr{color:#95e6cb}.s1{color:#d5ff80}.ss{color:#dfbfff}.bp{color:#5ccfe6}.fm{color:#ffd173}.vc{color:#d4d2c8}.vg{color:#d4d2c8}.vi{color:#d4d2c8}.vm{color:#d4d2c8}.il{color:#dfbfff}</style><link rel=preload href=../css/fonts/Montserrat-d757346.woff2 crossorigin=anonymous as=font type=font/woff2><link rel=stylesheet href=../css/katex.css media=print onload='this.media="all"'><noscript><link rel=stylesheet href=../css/katex.css></noscript><link rel="shortcut icon" href=favicon.ico type=image/x-icon><link rel="shortcut icon" href=../images/favicons/favicon32.png><link rel=apple-touch-icon-precomposed sizes=144x144 href=../images/favicons/favicon144.png><link rel=apple-touch-icon-precomposed sizes=114x114 href=../images/favicons/favicon114.png><link rel=apple-touch-icon-precomposed sizes=72x72 href=../images/favicons/favicon72.png><link rel=apple-touch-icon-precomposed sizes=57x57 href=../images/favicons/favicon57.png><header><nav class=header><a class=logo href=../>(Non-)Functional Ramblings</a><div class=navigation><a href=../about.html>About</a>
<a href=../static/resume.pdf>Resume</a>
<a href=../archive.html>Archive</a>
<a href=../atom.xml>Feed</a></div></nav></header><main role=main><h1 class=title>Can I pet your <em>DAG</em>?</h1><article><section class=publish-date><em>Posted on July 29, 2025</em></section><section><nav class=toc><div class=toc-header>Contents</div><ul><li><a href=#just-another-day-in-the-life id=toc-just-another-day-in-the-life>Just another day in the life</a><li><a href=#get-me-my-baton id=toc-get-me-my-baton>Get me my baton</a><li><a href=#wait-theres-two-of-them id=toc-wait-theres-two-of-them>Wait, there’s two of them!</a></ul></nav><p></p>Directed acyclic graphs appear quite often when analyzing problems. One such problem is one I’ve recently come across under the moniker of workflow orchestration. The key problem here is that you have a certain set of tasks with dependencies with one another, which you need to schedule in a correct ordering. Let’s look at some ways you can phrase (a severely restricted variant of) the problem using some nifty Haskell.<h2 id=just-another-day-in-the-life>Just another day in the life</h2><p></p>Let’s assume you have a set of predefined tasks, say the things you were to do on a particular day. Role-playing as a high-schooler, you’d go to school and maybe take an exam. Going home, maybe your dad asked you to get some groceries. Maybe in the afternoon do some homework or watch TV.<div class=highlight><pre tabindex=0><span></span><span class=kr>data</span><span class=w> </span><span class=kt>Task</span>
<span class=w>  </span><span class=ow>=</span><span class=w> </span><span class=kt>GoOutside</span>
<span class=w>  </span><span class=o>|</span><span class=w> </span><span class=kt>GoToSchool</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=kt>TakePhysics</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=kt>TakeExam</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=kt>GoHome</span>
<span class=w>  </span><span class=o>|</span><span class=w> </span><span class=kt>GetGroceries</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=kt>UnpackGroceries</span>
<span class=w>  </span><span class=o>|</span><span class=w> </span><span class=kt>HaveLunch</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=kt>DoHomework</span>
<span class=w>  </span><span class=o>|</span><span class=w> </span><span class=kt>HaveDinner</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=kt>WatchTV</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=kt>PlayVideoGames</span>
<span class=w>  </span><span class=o>|</span><span class=w> </span><span class=kt>GoToBed</span>
</pre></div><p></p>There’s a notion of dependencies here. You can only take an exam, if you’re at school. Dinner, TV or video games can only be in the afternoon. Going to bed has to occur at the end of the day. Drawing an example subset of these dependencies out, shows that it can already get quite convoluted. I’ll use the following in the rest of this text. Of course the example is contrived, but it’s merely for exhibition purposes anyway.<figure><p></p><img src=../images/mmd_DPGQCb6_0UI.svg title=mermaid-figure></figure><p></p>These describe the dependencies between tasks. Now say we have Billy and Bobby. Billy has to go to school, go to Physics class, and take a Math exam today. While Bobby doesn’t have school today and only has to do some grocery shopping.<figure><p></p><img src=../images/mmd_813VtSwDpZQ.svg title=mermaid-figure></figure><figure><p></p><img src=../images/mmd_sccUAUWV0l0.svg title=mermaid-figure></figure><p></p>While Billy and Bobby could take their actions independently, let’s say we have
to determine some global ordering between the actions they take, consistent with
the dependencies between their actions. One could say Billy does all of his
tasks first according to the above, and subsequently Bobby does all of his. But
that would mean that Bobby is waiting at home, all the while Billy is
productively at school. Instead, let’s force common nodes as synchronization
points, i.e. Bobby will definitely have done the groceries while Billy is at
school, and they’ll leave and get home at approximately the same
time<label for=sn-0 class="margin-toggle sidenote-number"></label><input type=checkbox id=sn-0 class=margin-toggle><div class=sidenote>It’s never taken me 6 hours to do groceries, but maybe Bobby is
doing groceries for an orphanage.</div><label for=sn-1 class="margin-toggle sidenote-number"></label><input type=checkbox id=sn-1 class=margin-toggle><div class=sidenote>Maybe they both hold one piece of a key, and the door to their house
only opens if both of them are there. I personally wouldn’t want this lock,
but I’ve heard it sells like hotcakes in BillyBobbyLand.</div><label for=sn-2 class="margin-toggle sidenote-number"></label><input type=checkbox id=sn-2 class=margin-toggle><div class=sidenote>Did I mention that this is all extremely contrived? Like all great
decisions, the idea for this blog post came from a wrong solution to a
problem I had, now fitted to a nonexistent one.</div>.<p></p>While the previous convoluted graph phrased dependencies between tasks, the
following shows a concrete set of given tasks that have to occur. Our main goal
now is to find a way to operate on schedules of them that obey the dependency relationships between tasks.<figure><p></p><img src=../images/mmd_9byq1pDGluk.svg title=mermaid-figure></figure><h2 id=get-me-my-baton>Get me my baton</h2><p></p>We can phrase dependencies as a <code>Map Task [Task]</code> along with a <code>dependsOn</code>
function that emits whether two tasks are transitively dependent, as the
following.<div class=highlight><pre tabindex=0><span></span><span class=nf>dependsOn</span><span class=w> </span><span class=ow>::</span><span class=w> </span><span class=kt>Task</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>Task</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>Bool</span>
<span class=nf>dependsOn</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=n>t2</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=kr>case</span><span class=w> </span><span class=kt>Map</span><span class=o>.</span><span class=n>lookup</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=n>dependencies</span><span class=w> </span><span class=kr>of</span>
<span class=w>  </span><span class=kt>Nothing</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>False</span>
<span class=w>  </span><span class=kt>Just</span><span class=w> </span><span class=n>deps</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=n>t2</span><span class=w> </span><span class=p>`</span><span class=n>elem</span><span class=p>`</span><span class=w> </span><span class=n>deps</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>any</span><span class=w> </span><span class=p>(</span><span class=nf>\</span><span class=n>d</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=n>d</span><span class=w> </span><span class=p>`</span><span class=n>dependsOn</span><span class=p>`</span><span class=w> </span><span class=n>t2</span><span class=p>)</span><span class=w> </span><span class=n>deps</span>
</pre></div><p></p>If we wanted to find a global schedule between Billy and Bobby, one naive approach would be to do comparisons using this <code>dependsOn</code> function, adding an action to the schedule only if it has no dependencies remaining.<div class=highlight><pre tabindex=0><span></span><span class=kr>data</span><span class=w> </span><span class=kt>Actor</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=kt>Billy</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=kt>Bobby</span>
<span class=kr>type</span><span class=w> </span><span class=kt>Action</span><span class=w> </span><span class=n>task</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=p>(</span><span class=n>task</span><span class=p>,</span><span class=w> </span><span class=kt>Actor</span><span class=p>)</span>

<span class=nf>billyTodo</span><span class=p>,</span><span class=w> </span><span class=n>bobbyTodo</span><span class=p>,</span><span class=w> </span><span class=n>allTodos</span><span class=w> </span><span class=ow>::</span><span class=w> </span><span class=p>[</span><span class=kt>Action</span><span class=w> </span><span class=kt>Task</span><span class=p>]</span>
<span class=nf>billyTodo</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=n>map</span><span class=w> </span><span class=p>(,</span><span class=kt>Billy</span><span class=p>)</span><span class=w> </span><span class=p>[</span><span class=kt>GoOutside</span><span class=p>,</span><span class=w> </span><span class=kt>GoToSchool</span><span class=p>,</span><span class=w> </span><span class=kt>TakePhysics</span><span class=p>,</span><span class=w> </span><span class=kt>TakeExam</span><span class=p>,</span><span class=w> </span><span class=kt>GoHome</span><span class=p>]</span>
<span class=nf>bobbyTodo</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=n>map</span><span class=w> </span><span class=p>(,</span><span class=kt>Bobby</span><span class=p>)</span><span class=w> </span><span class=p>[</span><span class=kt>GoOutside</span><span class=p>,</span><span class=w> </span><span class=kt>GetGroceries</span><span class=p>,</span><span class=w> </span><span class=kt>GoHome</span><span class=p>,</span><span class=w> </span><span class=kt>UnpackGroceries</span><span class=p>]</span>
<span class=nf>allTodos</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=n>billyTodo</span><span class=w> </span><span class=o>&lt;&gt;</span><span class=w> </span><span class=n>bobbyTodo</span>

<span class=nf>scheduleNaive</span><span class=w> </span><span class=ow>::</span><span class=w> </span><span class=p>[</span><span class=kt>Action</span><span class=w> </span><span class=kt>Task</span><span class=p>]</span>
<span class=nf>scheduleNaive</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=n>reverse</span><span class=w> </span><span class=o>$</span><span class=w> </span><span class=n>go</span><span class=w> </span><span class=kt>[]</span><span class=w> </span><span class=n>allTodo</span>
<span class=w> </span><span class=kr>where</span>
<span class=w>  </span><span class=n>go</span><span class=w> </span><span class=n>acc</span><span class=w> </span><span class=p>(</span><span class=n>act</span><span class=o>@</span><span class=p>(</span><span class=n>t</span><span class=p>,</span><span class=w> </span><span class=kr>_</span><span class=p>)</span><span class=w> </span><span class=kt>:</span><span class=w> </span><span class=n>actions</span><span class=p>)</span>
<span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>not</span><span class=w> </span><span class=p>(</span><span class=n>any</span><span class=w> </span><span class=p>(</span><span class=n>dependsOn</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>.</span><span class=w> </span><span class=n>fst</span><span class=p>)</span><span class=w> </span><span class=n>actions</span><span class=p>)</span><span class=w> </span><span class=ow>=</span>
<span class=w>        </span><span class=n>go</span><span class=w> </span><span class=p>(</span><span class=n>act</span><span class=w> </span><span class=kt>:</span><span class=w> </span><span class=n>acc</span><span class=p>)</span><span class=w> </span><span class=n>actions</span>
<span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>otherwise</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=n>go</span><span class=w> </span><span class=n>acc</span><span class=w> </span><span class=p>(</span><span class=n>actions</span><span class=w> </span><span class=o>&lt;&gt;</span><span class=w> </span><span class=p>[</span><span class=n>act</span><span class=p>])</span>
<span class=w>  </span><span class=n>go</span><span class=w> </span><span class=n>acc</span><span class=w> </span><span class=kr>_</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=n>acc</span>
</pre></div><p></p>This approach does a quadratic number of comparisons between the tasks in
the set, however, as we compare each action to every other action. In this case,
we can do a bit better.<p></p>Dependency relationships as we’ve phrased them here form a poset, some tasks can
be transitively inferred to have to occur prior to others, but other
combinations of tasks cannot, i.e. <code>GetGroceries</code> and <code>TakeExam</code> for example. We
can turn this poset into a total ordering using a topological sort.<p></p>First we define a graph from our same adjacency <code>Map</code>, using the <code>containers</code>’
<code>Data.Graph</code>. We can use the int-mapping associated with <code>Enum</code>s to get the
vertices of our graph.<div class=highlight><pre tabindex=0><span></span><span class=nf>dependencyDAG</span><span class=w> </span><span class=ow>::</span><span class=w> </span><span class=kt>Array</span><span class=o>.</span><span class=kt>Array</span><span class=w> </span><span class=kt>Int</span><span class=w> </span><span class=p>[</span><span class=kt>Int</span><span class=p>]</span>
<span class=nf>dependencyDAG</span><span class=w> </span><span class=ow>=</span>
<span class=w>  </span><span class=kt>Array</span><span class=o>.</span><span class=n>array</span><span class=w> </span><span class=p>(</span><span class=n>fromEnum</span><span class=w> </span><span class=p>(</span><span class=n>minBound</span><span class=w> </span><span class=ow>::</span><span class=w> </span><span class=kt>Task</span><span class=p>),</span><span class=w> </span><span class=n>fromEnum</span><span class=w> </span><span class=p>(</span><span class=n>maxBound</span><span class=w> </span><span class=ow>::</span><span class=w> </span><span class=kt>Task</span><span class=p>))</span><span class=w> </span><span class=o>$</span>
<span class=w>    </span><span class=n>map</span><span class=w> </span><span class=p>(</span><span class=n>bimap</span><span class=w> </span><span class=n>fromEnum</span><span class=w> </span><span class=p>(</span><span class=n>map</span><span class=w> </span><span class=n>fromEnum</span><span class=p>))</span><span class=w> </span><span class=o>$</span>
<span class=w>      </span><span class=kt>Map</span><span class=o>.</span><span class=n>toList</span><span class=w> </span><span class=n>dependencies</span>
</pre></div><p></p>From the relative positions within a topological sort, we can then derive a total ordering of all tasks within our domain.<div class=highlight><pre tabindex=0><span></span><span class=nf>topologicSortedTasks</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=n>map</span><span class=w> </span><span class=n>toEnum</span><span class=w> </span><span class=o>$</span><span class=w> </span><span class=kt>Graph</span><span class=o>.</span><span class=n>reverseTopSort</span><span class=w> </span><span class=n>dependencyDAG</span>
<span class=nf>totallyOrderedTasks</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=kt>Map</span><span class=o>.</span><span class=n>fromList</span><span class=w> </span><span class=o>$</span><span class=w> </span><span class=n>zip</span><span class=w> </span><span class=n>topologicSortedTasks</span><span class=w> </span><span class=p>[</span><span class=mi>0</span><span class=w> </span><span class=o>..</span><span class=p>]</span>

<span class=kr>newtype</span><span class=w> </span><span class=kt>OrderedTask</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=kt>OrderedTask</span><span class=w> </span><span class=kt>Task</span><span class=w> </span><span class=kr>deriving</span><span class=w> </span><span class=kr>newtype</span><span class=w> </span><span class=p>(</span><span class=kt>Eq</span><span class=p>,</span><span class=w> </span><span class=kt>Show</span><span class=p>)</span>
<span class=kr>instance</span><span class=w> </span><span class=kt>Ord</span><span class=w> </span><span class=kt>OrderedTask</span><span class=w> </span><span class=kr>where</span>
<span class=w>  </span><span class=n>compare</span><span class=w> </span><span class=p>(</span><span class=kt>OrderedTask</span><span class=w> </span><span class=n>t1</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=kt>OrderedTask</span><span class=w> </span><span class=n>t2</span><span class=p>)</span><span class=w> </span><span class=ow>=</span>
<span class=w>    </span><span class=p>(</span><span class=n>totallyOrderedTasks</span><span class=w> </span><span class=kt>Map</span><span class=o>.!</span><span class=w> </span><span class=n>t1</span><span class=p>)</span><span class=w> </span><span class=p>`</span><span class=n>compare</span><span class=p>`</span><span class=w> </span><span class=p>(</span><span class=n>totallyOrderedTasks</span><span class=w> </span><span class=kt>Map</span><span class=o>.!</span><span class=w> </span><span class=n>t2</span><span class=p>)</span>
</pre></div><p></p>We can check this works on our example day in the lives of Billy and Bobby.<div class=highlight><pre tabindex=0><span></span><span class=nf>allTodosLinear</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=n>map</span><span class=w> </span><span class=p>(</span><span class=n>first</span><span class=w> </span><span class=kt>OrderedTask</span><span class=p>)</span><span class=w> </span><span class=n>allTodos</span>
<span class=nf>scheduleLinear</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=n>sort</span><span class=w> </span><span class=n>allTodosLinear</span>
<span class=c1>-- &gt; scheduleLinear == scheduleNaive ==</span>
<span class=c1>-- &gt;  [ (GoOutside, Billy)</span>
<span class=c1>-- &gt;  , (GoOutside, Bobby)</span>
<span class=c1>-- &gt;  , (GoToSchool, Billy)</span>
<span class=c1>-- &gt;  , (TakePhysics, Billy)</span>
<span class=c1>-- &gt;  , (TakeExam, Billy)</span>
<span class=c1>-- &gt;  , (GetGroceries, Bobby)</span>
<span class=c1>-- &gt;  , (GoHome, Billy)</span>
<span class=c1>-- &gt;  , (GoHome, Bobby)</span>
<span class=c1>-- &gt;  , (UnpackGroceries, Bobby)</span>
<span class=c1>-- &gt;  ]</span>
</pre></div><p></p>Using <code>OrderedTask</code>, we can even maintain a priority queue on the next action to occur by turning it into a <code>Set</code>. Keeping with that idea, we can even interrupt the global schedule and push new sets of actions onto the queue, like Billy helping Bobby unpack groceries.<div class=highlight><pre tabindex=0><span></span><span class=nf>actionQueue</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=kt>Set</span><span class=o>.</span><span class=n>fromList</span><span class=w> </span><span class=n>allTodosLinear</span>

<span class=nf>nextAction</span><span class=w> </span><span class=ow>::</span><span class=w> </span><span class=kt>Set</span><span class=o>.</span><span class=kt>Set</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>Maybe</span><span class=w> </span><span class=p>(</span><span class=n>a</span><span class=p>,</span><span class=w> </span><span class=kt>Set</span><span class=o>.</span><span class=kt>Set</span><span class=w> </span><span class=n>a</span><span class=p>)</span>
<span class=nf>nextAction</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=kt>Set</span><span class=o>.</span><span class=n>minView</span>

<span class=nf>newActionQueue</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=kt>Set</span><span class=o>.</span><span class=n>insert</span><span class=w> </span><span class=p>(</span><span class=kt>UnpackGroceries</span><span class=p>,</span><span class=w> </span><span class=kt>Billy</span><span class=p>)</span><span class=w> </span><span class=n>actionQueue</span>
<span class=c1>-- &gt; Set.toList newActionQueue ==</span>
<span class=c1>-- &gt;  [ ...</span>
<span class=c1>-- &gt;  , (GetGroceries, Bobby)</span>
<span class=c1>-- &gt;  , (GoHome, Billy)</span>
<span class=c1>-- &gt;  , (GoHome, Bobby)</span>
<span class=c1>-- &gt;  , (UnpackGroceries, Billy)</span>
<span class=c1>-- &gt;  , (UnpackGroceries, Bobby)</span>
<span class=c1>-- &gt;  ]</span>
</pre></div><h2 id=wait-theres-two-of-them>Wait, there’s two of them!</h2><p></p>While nifty, using <code>Set</code> as a priority queue for a poset isn’t particularly
useful. By turning the poset formed by the dependencies between tasks into a
total ordering, we essentially force that no two actions can occur at the same
time. Billy can’t have his exam, exactly while Bobby is doing groceries. Even
better, using the above queue, we’d only have Bobby start doing groceries
<em>after</em> Billy is done with his exam.<figure><p></p><img src=../images/mmd_lzic2tn_LvA.svg title=mermaid-figure></figure><figure><p></p><img src=../images/mmd_qJaMERZuDZ0.svg title=mermaid-figure></figure><p></p>So we exactly lose what makes a poset so useful in phrasing parallelizeable
tasks. In the nomenclature, Billy and Bobby’s tasklists are also knows as
chains. Every element in a chain can be compared with one another. Antichains
are the inverse. They are (sub)sets that contain elements of which no two
elements can be compared with one another. Antichains are <em>precisely</em> the tasks
that can be executed in parallel.<p></p>Less nifty is what I now end up with if I do want to preserve the poset, and want to maintain the minimal antichains in the current set of to-be-scheduled tasks.<div class=highlight><pre tabindex=0><span></span><span class=kr>data</span><span class=w> </span><span class=kt>NextTask</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=kt>NextTask</span>
<span class=w>  </span><span class=p>{</span><span class=w> </span><span class=n>dependencyCounts</span><span class=w> </span><span class=ow>::</span><span class=w> </span><span class=kt>HashMap</span><span class=o>.</span><span class=kt>HashMap</span><span class=w> </span><span class=kt>Task</span><span class=w> </span><span class=kt>Int</span>
<span class=w>  </span><span class=c1>-- ^ Maintain how many tasks block each one currently in the schedule.</span>
<span class=w>  </span><span class=p>,</span><span class=w> </span><span class=n>roots</span><span class=w> </span><span class=ow>::</span><span class=w> </span><span class=kt>HashSet</span><span class=o>.</span><span class=kt>HashSet</span><span class=w> </span><span class=kt>Task</span>
<span class=w>  </span><span class=c1>-- ^ Keep track of tasks with no current dependencies.</span>
<span class=w>  </span><span class=p>}</span>
</pre></div><p></p>I’ll leave how to keep this datatype up to date to keep queries reasonably fast
as an exercise to the reader. For a solution, check <a href=../appendix/can-i-pet-your-dag-code.html>the
appendix</a>. It would’ve been pretty
cool to have a use case where losing the poset-iness of a poset doesn’t hamper
functionality, in which case turning it into a priority-queue via <code>Set</code> would
have been <em>very</em> <a href="https://www.youtube.com/watch?v=3WAOxKOmR90"><em>nice</em></a><label for=sn-3 class="margin-toggle sidenote-number"></label><input type=checkbox id=sn-3 class=margin-toggle><div class=sidenote>I really, really like the various <code>Ord</code>-specific functionalities <code>Map</code>
and <code>Set</code> provide. They’re not that common in other languages as far as I
know, and If you phrase your key types <em>just</em> right, you can do very nifty
things and query some sets of facts very efficiently.</div>.</section></article></main><footer>Site proudly generated by <a href=http://jaspervdj.be/hakyll>Hakyll</a>.
All content is licensed under <a href=../LICENSE.txt>3-clause BSD license</a>.</footer>