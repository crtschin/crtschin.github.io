<!doctype html><html lang=en><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Newtypes are generally useful to avoid parameter-blindness, but can be cumbersome if each type has it's own wrapper. I explore the use of TypeData and phantom types in Haskell as an alternative way to improve type safety and reduce developer errors."><title>(Non-)Functional Ramblings - Harder-Coded Newtypes</title><style>@font-face{font-family:fira code;font-style:normal;font-weight:300 700;font-display:swap;src:local("Fira Code"),local("FiraCode"),url(/css/fonts/FiraCode-52cbcc5.woff2)format('woff2-variations')}@font-face{font-family:montserrat;font-style:normal;font-weight:100 900;font-display:swap;src:local("Montserrat"),url(/css/fonts/Montserrat-52cbcc5.woff2)format('woff2-variations')}@font-face{font-family:montserrat;font-style:italic;font-weight:100 900;font-display:swap;src:local("Montserrat Italic"),local("Montserrat-Italic"),url(/css/fonts/Montserrat-Italic-52cbcc5.woff2)format('woff2-variations')}html{font-size:80%;font-weight:400;font-family:montserrat,arial,sans-serif;scroll-behavior:smooth;scrollbar-gutter:stable}html{text-size-adjust:none}*,*::before,*::after{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;-ms-box-sizing:border-box;-o-box-sizing:border-box;box-sizing:border-box}body{line-height:1.5;-webkit-font-smoothing:antialiased}input,button,textarea,select{font:inherit}p,h1,h2,h3,h4,h5,h6{overflow-wrap:break-word}#root,#__next{isolation:isolate}body{font-size:1.6rem;background-color:#282828;color:#fbf1c7}code,pre{background-color:#1d2021}header{border-bottom:.2rem solid #98971a}nav a{font-weight:700;text-decoration:none}body img{max-width:100%;max-height:100%;display:block;margin:auto;height:auto;width:auto}body figcaption{text-align:center}footer{margin-top:3rem;padding:1.2rem 0;border-top:.2rem solid #98971a;font-size:1.2rem;color:#fbf1c7}h1{font-size:2.4rem}h2{font-size:2rem}h3{font-size:1.8rem}h4{font-size:1.6rem}.title{margin-bottom:0}article .publish-date{margin:0 0 2rem 1rem;font-size:1.4rem;color:#fbf1c7}article .last-modified-date{font-size:1rem}.logo a{font-weight:700;color:#fbf1c7;text-decoration:none}html{scrollbar-width:thick;scrollbar-color:#928374 #282828}pre{scrollbar-width:thin;scrollbar-color:#928374 #282828}nav.toc{float:left;clear:left;font-size:2rem;margin-left:-28%;width:20rem;word-wrap:break-word;padding:1rem;vertical-align:baseline;position:-webkit-sticky;position:sticky;top:5vh}nav.toc a{font-size:1.4rem}nav.toc ::marker{margin:0 -1rem 0 0}nav.toc li{margin:0;padding:0;line-height:1.2}nav.toc .toc-header{font-weight:700}nav.toc ul li{list-style-position:outside}nav.toc ul{margin-top:0;margin-bottom:0}pre,code{width:100%;font-family:fira code,consolas,monospace}div.highlight.inline{display:inline}pre{white-space:pre;overflow:auto;margin:1rem 0;background-color:#1d2021;padding:1rem;border-radius:.5rem .5rem .5rem .5rem}code{word-break:break-word;padding:0 .4rem;border-radius:.3rem .3rem .3rem .3rem}html a:link{color:#689d6a;background-color:initial;text-decoration:underline}html a:visited{color:#689d6a;background-color:initial;text-decoration:underline}html a:hover{color:#8ec07c;background-color:initial;text-decoration:underline}html a:active{color:#8ec07c;background-color:initial;text-decoration:none}nav.header a:link{color:#689d6a;background-color:initial;text-decoration:none}nav.header a:visited{color:#689d6a;background-color:initial;text-decoration:none}nav.header a:hover{color:#8ec07c;background-color:initial;text-decoration:none}nav.header a:active{color:#8ec07c;background-color:initial;text-decoration:underline}nav.toc a:link{color:#689d6a;background-color:initial;text-decoration:none}nav.toc a:visited{color:#689d6a;background-color:initial;text-decoration:none}nav.toc a:hover{color:#8ec07c;background-color:initial;text-decoration:none}nav.toc a:active{color:#8ec07c;background-color:initial;text-decoration:underline}.sidenote,marginnote{width:20rem;clear:right;font-size:1.1rem;line-height:1.3;vertical-align:baseline}body{counter-set:sidenote-counter}.sidenote-number{counter-increment:sidenote-counter}.sidenote:before{content:counter(sidenote-counter)" ";position:relative;vertical-align:baseline;font-weight:700;font-size:1rem;top:-.5rem;font-size:.9em}.sidenote-number:after{content:counter(sidenote-counter);position:relative;vertical-align:baseline;font-weight:700;font-size:1rem;top:-.5rem;left:.1rem}blockquote .sidenote,blockquote .marginnote{margin-right:82%;min-width:59%;text-align:left}.sidenote>code{font-size:1rem}label.sidenote-number{display:inline-block;max-height:2rem}label.margin-toggle:not(.sidenote-number){display:none}input.margin-toggle{display:none}@media all and (max-width:1439px){nav.toc{display:none}}@media all and (max-width:1439px){.sidenote,.marginnote{float:right;text-align:left;margin:1rem 0;padding-left:5%}}@media all and (min-width:1440px){.sidenote,.marginnote{float:right;margin-right:-30%;margin-top:.3rem;margin-bottom:0;position:relative}}@media all and (max-width:639px){body{width:100%;margin:0;padding:0 5%}header{margin:1rem 0}nav.header{margin:.5rem auto;text-align:center}footer{text-align:center}nav.header a{font-size:1.4rem;line-height:1.6}.logo{font-size:1.8rem}nav.header a{margin:0 .6rem}}@media all and (min-width:640px){body{width:70rem;margin:0 auto;padding:0}header{margin:0 0 3rem;padding:.6rem 0 .2rem}nav.header{display:flex;align-items:flex-end;justify-content:space-between;margin:0;text-align:right}nav.header a{font-size:1.8rem;margin:0 0 0 .6rem;display:inline}.navigation{justify-content:flex-end}footer{text-align:right}.logo{margin:0;text-align:left;font-size:2.4rem}}pre{line-height:125%}td.linenos .normal{color:#3c4354;background-color:initial;padding-left:5px;padding-right:5px}span.linenos{color:#3c4354;background-color:initial;padding-left:5px;padding-right:5px}td.linenos .special{color:#3c4354;background-color:#ffffc0;padding-left:5px;padding-right:5px}span.linenos.special{color:#3c4354;background-color:#ffffc0;padding-left:5px;padding-right:5px}.hll{background-color:#6e7681}.c{color:#7e8aa1}.err{color:#f88f7f}.esc{color:#d4d2c8}.g{color:#d4d2c8}.k{color:#ffad66}.l{color:#d5ff80}.n{color:#d4d2c8}.o{color:#ffad66}.x{color:#d4d2c8}.p{color:#d4d2c8}.ch{color:#f88f7f;font-style:italic}.cm{color:#7e8aa1}.cp{color:#ffad66;font-weight:700}.cpf{color:#7e8aa1}.c1{color:#7e8aa1}.cs{color:#7e8aa1;font-style:italic}.gd{color:#f88f7f;background-color:#3d1e20}.ge{color:#d4d2c8;font-style:italic}.ges{color:#d4d2c8}.gr{color:#f88f7f}.gh{color:#d4d2c8}.gi{color:#6ad4af;background-color:#19362c}.go{color:#7e8aa1}.gp{color:#d4d2c8}.gs{color:#d4d2c8;font-weight:700}.gu{color:#d4d2c8}.gt{color:#f88f7f}.kc{color:#ffad66}.kd{color:#ffad66}.kn{color:#ffad66}.kp{color:#ffad66}.kr{color:#ffad66}.kt{color:#73d0ff}.ld{color:#d5ff80}.m{color:#dfbfff}.s{color:#d5ff80}.na{color:#ffd173}.nb{color:#ffd173}.nc{color:#73d0ff}.no{color:#ffd173}.nd{color:#7e8aa1;font-weight:700;font-style:italic}.ni{color:#95e6cb}.ne{color:#73d0ff}.nf{color:#ffd173}.nl{color:#d4d2c8}.nn{color:#d4d2c8}.nx{color:#d4d2c8}.py{color:#ffd173}.nt{color:#5ccfe6}.nv{color:#d4d2c8}.ow{color:#ffad66}.pm{color:#d4d2c8}.w{color:#d4d2c8}.mb{color:#dfbfff}.mf{color:#dfbfff}.mh{color:#dfbfff}.mi{color:#dfbfff}.mo{color:#dfbfff}.sa{color:#f29e74}.sb{color:#d5ff80}.sc{color:#d5ff80}.dl{color:#d5ff80}.sd{color:#7e8aa1}.s2{color:#d5ff80}.se{color:#95e6cb}.sh{color:#d5ff80}.si{color:#95e6cb}.sx{color:#95e6cb}.sr{color:#95e6cb}.s1{color:#d5ff80}.ss{color:#dfbfff}.bp{color:#5ccfe6}.fm{color:#ffd173}.vc{color:#d4d2c8}.vg{color:#d4d2c8}.vi{color:#d4d2c8}.vm{color:#d4d2c8}.il{color:#dfbfff}</style><link rel=preload href=../css/fonts/Montserrat-52cbcc5.woff2 crossorigin=anonymous as=font type=font/woff2><link rel=stylesheet href=../css/katex.css media=print onload='this.media="all"'><noscript><link rel=stylesheet href=../css/katex.css></noscript><link rel="shortcut icon" href=favicon.ico type=image/x-icon><link rel="shortcut icon" href=../images/favicons/favicon32.png><link rel=apple-touch-icon-precomposed sizes=144x144 href=../images/favicons/favicon144.png><link rel=apple-touch-icon-precomposed sizes=114x114 href=../images/favicons/favicon114.png><link rel=apple-touch-icon-precomposed sizes=72x72 href=../images/favicons/favicon72.png><link rel=apple-touch-icon-precomposed sizes=57x57 href=../images/favicons/favicon57.png><header><nav class=header><a class=logo href=../>(Non-)Functional Ramblings</a><div class=navigation><a href=../about.html>About</a>
<a href=../static/resume.pdf>Resume</a>
<a href=../archive.html>Archive</a>
<a href=../atom.xml>Feed</a></div></nav></header><main role=main><h1 class=title>Harder-Coded Newtypes</h1><article><section class=publish-date><em>Posted on October 20, 2024</em></section><section><nav class=toc><div class=toc-header>Contents</div><ul><li><a href=#the-example id=toc-the-example>The Example</a><ul><li><a href=#so-newtype id=toc-so-newtype><em>So‚Ä¶ Newtype</em>?</a><li><a href=#no-phantoms id=toc-no-phantoms><strong><em>No, Phantoms!</em></strong></a></ul><li><a href=#a-bit-contrived id=toc-a-bit-contrived>A Bit Contrived</a></ul></nav><p></p>There‚Äôs quite a few fun and nifty things you can do in Haskell to avoid developer error. A notable one is the usage of <a href=https://wiki.haskell.org/Newtype><code>newtypes</code></a>, which some other <a href=https://doc.rust-lang.org/rust-by-example/generics/new_types.html>languages</a> <a href=https://docs.python.org/3/library/typing.html#newtype>have</a> adopted. It avoids parameter blindness and ensures values are only used in specific locations.<p></p>The trick I‚Äôd like to show right now, is to use <a href=https://ghc.gitlab.haskell.org/ghc/doc/users_guide/exts/data_kinds.html#extension-DataKinds><code>DataKinds</code></a> (or <a href=https://ghc.gitlab.haskell.org/ghc/doc/users_guide/exts/type_data.html#extension-TypeData><code>TypeData</code></a>) to achieve something similar using type-level tag values. A simple application of a technique fleshed out quite well in <a href=https://kataskeue.com/gdp.pdf>this paper</a>, which has a sick name (<em>Ghosts of Departed Proofs</em>), by Matt Noonan.<h2 id=the-example>The Example</h2><p></p>The easiest example I can think of, is none other than this blog! In the Hakyll setup of this blog, I add metadata to some posts. Two markers I use for example, are <code>published</code>, to indicate whether the post should be visible, and <code>includetoc</code>, to include a generated table of contents, partly using the general flow described in <a href=https://odone.me/posts/2020-05-25-hakyll-production-drafts/>this blogpost</a> by Riccardo Odone.<div class=highlight><pre tabindex=0><span></span><span class=nn>---</span>
<span class=c1># Example of what this metadata looks like at the top of a</span>
<span class=c1># markdown post. Hakyll parses this section as yaml.</span>
<span class=nt>title</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Harder-Coded</span>
<span class=nt>ispublished</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class=nt>includetoc</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class=nn>---</span>
</pre></div><p></p>Both of the metadata fields are booleans<label for=sn-0 class="margin-toggle sidenote-number"></label><input type=checkbox id=sn-0 class=margin-toggle><div class=sidenote>When passing booleans, however, it becomes quite ambiguous what the user has to pass (e.g.¬†Python and Haskell both capitalize the first letter, while go and rust don‚Äôt, yaml even accepts <code>yes</code> and <code>no</code>).<p></p>Getting from strings to booleans, is even worse if the language decides to do automatic conversions instead of forcing the user to properly parse. Looking at you <a href=https://www.destroyallsoftware.com/talks/wat>javascript</a>. <span class=emoji data-emoji=eyes>üëÄ</span><p></p>But even if you did parse appropriately, parse what exactly? Do you accept all of <code>1</code>, <code>true</code>, <code>True</code>, <code>TRUE</code>, <code>yes</code>? How about <code>sure</code>, <code>ok</code>, <code>affirmative</code> or <code>accept</code>? Language specifications are important. <span class=emoji data-emoji=relieved>üòå</span></div>. In my case, I want to arbitrarily accept <code>true</code>-ish values, case-insensitively matching <code>yes</code> or <code>true</code>. But simply returning booleans ‚Äòas is‚Äô, loses the metadata key associated with the value.<div class=highlight><pre tabindex=0><span></span><span class=c1>-- The `Bool` has no connection to the fact that it was pulled from the</span>
<span class=c1>-- &quot;published&quot; key.</span>
<span class=nf>checkPublished'</span><span class=w> </span><span class=ow>::</span><span class=w> </span><span class=kt>String</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>Metadata</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>Bool</span>
<span class=nf>checkPublished'</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=n>meta</span><span class=w> </span><span class=ow>=</span>
<span class=w>  </span><span class=kr>case</span><span class=w> </span><span class=n>lookupString</span><span class=w> </span><span class=s>&quot;published&quot;</span><span class=w> </span><span class=n>meta</span><span class=w> </span><span class=kr>of</span>
<span class=w>    </span><span class=kt>Nothing</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>False</span>
<span class=w>    </span><span class=kt>Just</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=n>map</span><span class=w> </span><span class=n>toLower</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=p>`</span><span class=n>elem</span><span class=p>`</span><span class=w> </span><span class=p>[</span><span class=s>&quot;yes&quot;</span><span class=p>,</span><span class=w> </span><span class=s>&quot;true&quot;</span><span class=p>]</span>
</pre></div><h3 id=so-newtype><em>So‚Ä¶ Newtype</em>?</h3><p></p>The simplest alternative is to create a newtype for specifically the <code>publish</code> boolean and to explicitly keep that separate.<div class=highlight><pre tabindex=0><span></span><span class=kr>newtype</span><span class=w> </span><span class=kt>IsPublished</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=kt>IsPublished</span><span class=w> </span><span class=p>{</span><span class=n>isPublished</span><span class=w> </span><span class=ow>::</span><span class=w> </span><span class=kt>Bool</span><span class=p>}</span>

<span class=nf>checkPublished''</span><span class=w> </span><span class=ow>::</span><span class=w> </span><span class=kt>String</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>Metadata</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>IsPublished</span>
<span class=nf>checkPublished''</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=n>meta</span><span class=w> </span><span class=ow>=</span>
<span class=w>  </span><span class=kr>case</span><span class=w> </span><span class=n>fmap</span><span class=w> </span><span class=kt>Text</span><span class=o>.</span><span class=n>pack</span><span class=w> </span><span class=p>(</span><span class=n>lookupString</span><span class=w> </span><span class=s>&quot;published&quot;</span><span class=w> </span><span class=n>meta</span><span class=p>)</span><span class=w> </span><span class=kr>of</span>
<span class=w>    </span><span class=kt>Nothing</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>IsPublished</span><span class=w> </span><span class=kt>False</span>
<span class=w>    </span><span class=kt>Just</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>IsPublished</span><span class=w> </span><span class=o>$</span><span class=w> </span><span class=kt>Text</span><span class=o>.</span><span class=n>toLower</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=p>`</span><span class=n>elem</span><span class=p>`</span><span class=w> </span><span class=p>[</span><span class=s>&quot;yes&quot;</span><span class=p>,</span><span class=w> </span><span class=s>&quot;true&quot;</span><span class=p>]</span>

<span class=nf>filterPublished'</span><span class=w> </span><span class=ow>::</span><span class=w> </span><span class=p>[(</span><span class=kt>IsPublished</span><span class=p>,</span><span class=w> </span><span class=kt>Post</span><span class=p>)]</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=p>[</span><span class=kt>Post</span><span class=p>]</span>
<span class=nf>filterPublished'</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=n>mapMaybe</span><span class=w> </span><span class=o>$</span>
<span class=w>  </span><span class=nf>\</span><span class=p>(</span><span class=n>flag</span><span class=p>,</span><span class=w> </span><span class=n>post</span><span class=p>)</span><span class=w> </span><span class=ow>-&gt;</span>
<span class=w>    </span><span class=kr>if</span><span class=w> </span><span class=n>isPublished</span><span class=w> </span><span class=n>flag</span>
<span class=w>      </span><span class=kr>then</span><span class=w> </span><span class=kt>Just</span><span class=w> </span><span class=n>post</span>
<span class=w>      </span><span class=kr>else</span><span class=w> </span><span class=kt>Nothing</span>
</pre></div><p></p>But this now becomes problematic if I need similar logic for my <code>includetoc</code> metadata flag, do I copy and paste everything? Do I parameterize everything with a <code>(Bool -> a)</code> parameter that encompasses the newtype I‚Äôll add for each flag? That sounds esoteric and horrible!<h3 id=no-phantoms><strong><em>No, Phantoms!</em></strong></h3><p></p>A solution I like here, is akin to using <code>TypeData</code> with phantom tags that serve as proof witnesses of the checking function. That‚Äôs a lot of abstract type jargon that serves no one, so let‚Äôs break it down.<p></p><code>TypeData</code> is the extension that allows you to define type level values. The textbook case is type level naturals via <code>type data Nat = Zero | Succ Nat</code>. For our purposes, we‚Äôll use it to create small tags we can pass around.<div class=highlight><pre tabindex=0><span></span><span class=kr>type</span><span class=w> </span><span class=kr>data</span><span class=w> </span><span class=kt>Flags</span>
<span class=w>  </span><span class=ow>=</span><span class=w> </span><span class=kt>IsPublished</span>
<span class=w>  </span><span class=o>|</span><span class=w> </span><span class=kt>IncludeTableOfContents</span>
</pre></div><p></p>Phantom types are the fun idea of only carrying around knowledge via variables on the type level, with no equivalent on the value level. It‚Äôs a technique that‚Äôs used quite commonly in Haskell. In my case, I want to attach my tags to booleans, but only on the type level.<div class=highlight><pre tabindex=0><span></span><span class=kr>newtype</span><span class=w> </span><span class=kt>Flag</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=kt>Flag</span><span class=w> </span><span class=p>{</span><span class=n>getFlag</span><span class=w> </span><span class=ow>::</span><span class=w> </span><span class=kt>Bool</span><span class=p>}</span>
</pre></div><p></p>I didn‚Äôt change the underlying type, it‚Äôs still a <code>Bool</code>. I only added a type variable. One nice observation is that my <code>Flag IsPublished</code> is isomorphic to the <code>IsPublished</code> newtype I defined a bit ago.<p></p>Now I can use this flag to define generic functions over my flag types, and define ‚Äúsmart‚Äù constructors that introduce these type level constructors as witnesses of the fact that the flag was created correctly<label for=sn-1 class="margin-toggle sidenote-number"></label><input type=checkbox id=sn-1 class=margin-toggle><div class=sidenote>Without avoiding exporting the <code>Flag</code> constructor, this unfortunately doesn‚Äôt preclude someone manually creating a proof witness incorrectly. The <code>Flag</code> constructor essentially plays the role of <code>QED</code> in our functions, so incorrect usage means you introduce incorrect values, subverting why we‚Äôre doing this in the first place.<div class=highlight><pre tabindex=0><span></span><span class=nf>illegal</span><span class=w> </span><span class=ow>::</span><span class=w> </span><span class=kt>Flag</span><span class=w> </span><span class=kt>Published</span>
<span class=nf>illegal</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=kt>Flag</span><span class=w> </span><span class=kt>True</span>
</pre></div></div>.<div class=highlight><pre tabindex=0><span></span><span class=nf>checkFlag</span><span class=w> </span><span class=ow>::</span><span class=w> </span><span class=kt>String</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>Metadata</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>Flag</span><span class=w> </span><span class=n>a</span>
<span class=nf>checkFlag</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=n>meta</span><span class=w> </span><span class=ow>=</span>
<span class=w>  </span><span class=kr>case</span><span class=w> </span><span class=n>lookupString</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=n>meta</span><span class=w> </span><span class=kr>of</span>
<span class=w>    </span><span class=kt>Nothing</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>Flag</span><span class=w> </span><span class=kt>False</span>
<span class=w>    </span><span class=kt>Just</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>Flag</span><span class=w> </span><span class=o>$</span><span class=w> </span><span class=n>map</span><span class=w> </span><span class=n>toLower</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=p>`</span><span class=n>elem</span><span class=p>`</span><span class=w> </span><span class=p>[</span><span class=s>&quot;yes&quot;</span><span class=p>,</span><span class=w> </span><span class=s>&quot;true&quot;</span><span class=p>]</span>

<span class=nf>filterFlag</span><span class=w> </span><span class=ow>::</span><span class=w> </span><span class=p>[(</span><span class=kt>Flag</span><span class=w> </span><span class=n>a</span><span class=p>,</span><span class=w> </span><span class=kt>Post</span><span class=p>)]</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=p>[</span><span class=kt>Post</span><span class=p>]</span>
<span class=nf>filterFlag</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=n>mapMaybe</span><span class=w> </span><span class=o>$</span>
<span class=w>  </span><span class=nf>\</span><span class=p>(</span><span class=n>flag</span><span class=p>,</span><span class=w> </span><span class=n>post</span><span class=p>)</span><span class=w> </span><span class=ow>-&gt;</span>
<span class=w>    </span><span class=kr>if</span><span class=w> </span><span class=n>getFlag</span><span class=w> </span><span class=n>flag</span>
<span class=w>      </span><span class=kr>then</span><span class=w> </span><span class=kt>Just</span><span class=w> </span><span class=n>post</span>
<span class=w>      </span><span class=kr>else</span><span class=w> </span><span class=kt>Nothing</span>
</pre></div><h2 id=a-bit-contrived>A Bit Contrived</h2><p></p>So I‚Äôve discussed how to easily handle boolean flags in post metadata, but the same approach can be extended to other types of data as well. Say I wanted to support guest authors and put their names under titles in posts, but only when a guest author is actually relevant (otherwise it‚Äôs me!).<div class=highlight><pre tabindex=0><span></span><span class=nn>---</span>
<span class=nt>ispublished</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class=nt>includetoc</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class=nt>author</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Billy Bob Barker (fictional)</span>
<span class=nn>---</span>
</pre></div><p></p>If I follow a similar line of thinking as the previous section. I‚Äôd build a wrapper akin to <code>newtype Attribute a = Attribute (Maybe String)</code>, but then have almost, but not quite, the same logic as I do for <code>Flag</code>. This code duplication is again, kind of an eyesore. So let‚Äôs create something <em>a bit</em> more generic.<p></p>The identifiable pattern here, is that the datatype encodes a value whose construction is checked against <em>something</em> (that something could also be a mental heuristic, when hard-coding a value written by hand). I can write that as a datatype that can be specialized as both the <code>Attribute</code> and <code>Flag</code> types.<div class=highlight><pre tabindex=0><span></span><span class=c1>-- Generalizes both `Flag` and `Attribute`, and any other value type with an</span>
<span class=c1>-- additional phantom type variable.</span>
<span class=kr>newtype</span><span class=w> </span><span class=kt>MetaValue</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=kt>MetaValue</span><span class=w> </span><span class=p>{</span><span class=n>getMetaValue</span><span class=w> </span><span class=ow>::</span><span class=w> </span><span class=n>a</span><span class=p>}</span>

<span class=c1>-- These are isomorphic to my original phantom newtype wrappers.</span>
<span class=kr>type</span><span class=w> </span><span class=kt>Flag</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=kt>MetaValue</span><span class=w> </span><span class=kt>Bool</span><span class=w> </span><span class=n>a</span>
<span class=kr>type</span><span class=w> </span><span class=kt>Attribute</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=kt>MetaValue</span><span class=w> </span><span class=p>(</span><span class=kt>Maybe</span><span class=w> </span><span class=kt>String</span><span class=p>)</span><span class=w> </span><span class=n>a</span>
<span class=kr>type</span><span class=w> </span><span class=kr>data</span><span class=w> </span><span class=kt>Flags</span>
<span class=w>  </span><span class=ow>=</span><span class=w> </span><span class=kt>IsPublished</span>
<span class=w>  </span><span class=o>|</span><span class=w> </span><span class=kt>IncludeTableOfContents</span>
<span class=w>  </span><span class=c1>-- A tag I'll use for the guest-authorship.</span>
<span class=w>  </span><span class=o>|</span><span class=w> </span><span class=kt>GuestAuthor</span>

<span class=c1>-- I can write smart helper that specialize the type variables in MetaValue</span>
<span class=nf>flag</span><span class=w> </span><span class=ow>::</span><span class=w> </span><span class=kt>Bool</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>Flag</span><span class=w> </span><span class=n>a</span>
<span class=nf>flag</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=kt>MetaValue</span>
<span class=nf>getFlag</span><span class=w> </span><span class=ow>::</span><span class=w> </span><span class=kt>Flag</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>Bool</span>
<span class=nf>getFlag</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=n>getMetaValue</span>

<span class=nf>attribute</span><span class=w> </span><span class=ow>::</span><span class=w> </span><span class=kt>String</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>Attribute</span><span class=w> </span><span class=n>a</span>
<span class=nf>attribute</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=kt>MetaValue</span><span class=w> </span><span class=o>.</span><span class=w> </span><span class=kt>Just</span>
<span class=nf>getAttribute</span><span class=w> </span><span class=ow>::</span><span class=w> </span><span class=kt>Attribute</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>Maybe</span><span class=w> </span><span class=kt>String</span>
<span class=nf>getAttribute</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=n>getMetaValue</span>
</pre></div><p></p>Constructing this <code>MetaValue</code> datatype can be done generically, with the idea that its usages implement the assertion of whatever the specialized phantom will be filled with. I‚Äôll show what this means by reimplementing the truthy-parsing for flags, and the optional non-me authorship.<div class=highlight><pre tabindex=0><span></span><span class=nf>checkMetadata</span>
<span class=w>  </span><span class=ow>::</span><span class=w> </span><span class=n>a</span>
<span class=w>  </span><span class=ow>-&gt;</span><span class=w> </span><span class=p>(</span><span class=kt>String</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=n>a</span><span class=p>)</span>
<span class=w>  </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>String</span>
<span class=w>  </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>Metadata</span>
<span class=w>  </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>MetaValue</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=n>b</span>
<span class=nf>checkMetadata</span><span class=w> </span><span class=n>defaultValue</span><span class=w> </span><span class=n>f</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=n>meta</span><span class=w> </span><span class=ow>=</span>
<span class=w>  </span><span class=kr>case</span><span class=w> </span><span class=n>lookupString</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=n>meta</span><span class=w> </span><span class=kr>of</span>
<span class=w>    </span><span class=kt>Nothing</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>MetaValue</span><span class=w> </span><span class=n>defaultValue</span>
<span class=w>    </span><span class=kt>Just</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>MetaValue</span><span class=w> </span><span class=p>(</span><span class=n>f</span><span class=w> </span><span class=n>t</span><span class=p>)</span>

<span class=nf>checkFlag</span><span class=w> </span><span class=ow>::</span><span class=w> </span><span class=kt>String</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>Metadata</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>Flag</span><span class=w> </span><span class=n>a</span>
<span class=nf>checkFlag</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=n>checkMetadata</span><span class=w> </span><span class=kt>False</span><span class=w> </span><span class=n>parsesTrue</span>
<span class=w> </span><span class=kr>where</span>
<span class=w>  </span><span class=n>parsesTrue</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=n>map</span><span class=w> </span><span class=kt>Char</span><span class=o>.</span><span class=n>toLower</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=p>`</span><span class=n>elem</span><span class=p>`</span><span class=w> </span><span class=p>[</span><span class=s>&quot;yes&quot;</span><span class=p>,</span><span class=w> </span><span class=s>&quot;true&quot;</span><span class=p>]</span>

<span class=nf>checkAttribute</span><span class=w> </span><span class=ow>::</span><span class=w> </span><span class=p>(</span><span class=kt>String</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>Maybe</span><span class=w> </span><span class=kt>String</span><span class=p>)</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>String</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>Metadata</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>Attribute</span><span class=w> </span><span class=n>a</span>
<span class=nf>checkAttribute</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=n>checkMetadata</span><span class=w> </span><span class=kt>Nothing</span>
</pre></div><p></p>The specialized helpers ensure that usage sites can still limit what kind of constrained values are passed through, but even if it didn‚Äôt, the phantom type variables imply another barrier of entry before a function parameter is accepted.<p></p>One observation is that each type variable encodes one degree of functionality. I use the non-phantom variable to specialize to <code>Flag</code> and <code>Attribute</code>, to encode what kind of value is contained. While the phantom type variable encodes the key in the blogpost‚Äôs yaml that‚Äôs used to pull in the metadata value.<p></p>I‚Äôll finish this off with a showcase of value constructor functions and how easily they pull string data from the <code>Metadata</code> of a post into the typed world, applying any necessary conditions. All in all, a bit of a contrived exercise just to be able to use the same functions across multiple <code>newtypes</code>, but fun nonetheless.<div class=highlight><pre tabindex=0><span></span><span class=nf>isPublished</span><span class=w> </span><span class=ow>::</span><span class=w> </span><span class=kt>Metadata</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>Flag</span><span class=w> </span><span class=kt>IsPublished</span>
<span class=nf>isPublished</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=n>checkFlag</span><span class=w> </span><span class=s>&quot;published&quot;</span>

<span class=nf>hasToC</span><span class=w> </span><span class=ow>::</span><span class=w> </span><span class=kt>Metadata</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>Flag</span><span class=w> </span><span class=kt>IncludeTableOfContents</span>
<span class=nf>hasToC</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=n>checkFlag</span><span class=w> </span><span class=s>&quot;includetoc&quot;</span>

<span class=nf>getAuthor</span><span class=w> </span><span class=ow>::</span><span class=w> </span><span class=kt>Metadata</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>Attribute</span><span class=w> </span><span class=kt>GuestAuthor</span>
<span class=nf>getAuthor</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=n>checkAttribute</span><span class=w> </span><span class=n>isNotMe</span><span class=w> </span><span class=s>&quot;author&quot;</span>
<span class=w> </span><span class=kr>where</span>
<span class=w>  </span><span class=n>isNotMe</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=kr>if</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=s>&quot;Curtis Chin Jen Sem&quot;</span><span class=w> </span><span class=kr>then</span><span class=w> </span><span class=kt>Nothing</span><span class=w> </span><span class=kr>else</span><span class=w> </span><span class=kt>Just</span><span class=w> </span><span class=n>t</span>
</pre></div></section></article></main><footer>Site proudly generated by <a href=http://jaspervdj.be/hakyll>Hakyll</a>.
All content is licensed under <a href=../LICENSE.txt>3-clause BSD license</a>.</footer>