<!doctype html><html lang=en><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="This blog post discusses the implementation of a lazy initialization strategy for managing a pool of resources. Emphasizing the importance of deferring initialization to improve performance in scenarios where not all resources are needed simultaneously."><title>(Non-)Functional Ramblings - Lazy-ing in My Pool</title><style>@font-face{font-family:fira code;font-style:normal;font-weight:300 700;font-display:swap;src:local("Fira Code"),local("FiraCode"),url(/css/fonts/FiraCode-e561391.woff2)format('woff2-variations')}@font-face{font-family:montserrat;font-style:normal;font-weight:100 900;font-display:swap;src:local("Montserrat"),url(/css/fonts/Montserrat-e561391.woff2)format('woff2-variations')}@font-face{font-family:montserrat;font-style:italic;font-weight:100 900;font-display:swap;src:local("Montserrat Italic"),local("Montserrat-Italic"),url(/css/fonts/Montserrat-Italic-e561391.woff2)format('woff2-variations')}html{font-size:80%;font-weight:400;font-family:montserrat,arial,sans-serif;scroll-behavior:smooth;scrollbar-gutter:stable}html{text-size-adjust:none}*,*::before,*::after{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;-ms-box-sizing:border-box;-o-box-sizing:border-box;box-sizing:border-box}body{line-height:1.5;-webkit-font-smoothing:antialiased}input,button,textarea,select{font:inherit}p,h1,h2,h3,h4,h5,h6{overflow-wrap:break-word}#root,#__next{isolation:isolate}body{font-size:1.6rem;background-color:#282828;color:#fbf1c7}code,pre{background-color:#1d2021}header{border-bottom:.2rem solid #98971a}nav a{font-weight:700;text-decoration:none}body img{max-width:100%;max-height:100%;display:block;margin:auto;height:auto}body figcaption{text-align:center}footer{margin-top:3rem;padding:1.2rem 0;border-top:.2rem solid #98971a;font-size:1.2rem;color:#fbf1c7}h1{font-size:2.4rem}h2{font-size:2rem}h3{font-size:1.8rem}h4{font-size:1.6rem}.title{margin-bottom:0}article .publish-date{margin:0 0 2rem 1rem;font-size:1.4rem;color:#fbf1c7}.logo a{font-weight:700;color:#fbf1c7;text-decoration:none}html{scrollbar-width:thick;scrollbar-color:#928374 #282828}pre{scrollbar-width:thin;scrollbar-color:#928374 #282828}nav.toc{float:left;clear:left;font-size:2rem;margin-left:-28%;width:20rem;word-wrap:break-word;padding:1rem;vertical-align:baseline;position:-webkit-sticky;position:sticky;top:5vh}nav.toc a{font-size:1.4rem}nav.toc ::marker{margin:0 -1rem 0 0}nav.toc li{margin:0;padding:0;line-height:1.2}nav.toc .toc-header{font-weight:700}nav.toc ul li{list-style-position:outside}nav.toc ul{margin-top:0;margin-bottom:0}pre,code{width:100%;font-family:fira code,consolas,monospace}div.highlight.inline{display:inline}pre{white-space:pre;overflow:auto;margin:1rem 0;background-color:#1d2021;padding:1rem;border-radius:.5rem .5rem .5rem .5rem}code{word-break:break-word;padding:0 .4rem;border-radius:.3rem .3rem .3rem .3rem}html a:link{color:#689d6a;background-color:initial;text-decoration:underline}html a:visited{color:#689d6a;background-color:initial;text-decoration:underline}html a:hover{color:#8ec07c;background-color:initial;text-decoration:underline}html a:active{color:#8ec07c;background-color:initial;text-decoration:none}nav.header a:link{color:#689d6a;background-color:initial;text-decoration:none}nav.header a:visited{color:#689d6a;background-color:initial;text-decoration:none}nav.header a:hover{color:#8ec07c;background-color:initial;text-decoration:none}nav.header a:active{color:#8ec07c;background-color:initial;text-decoration:underline}nav.toc a:link{color:#689d6a;background-color:initial;text-decoration:none}nav.toc a:visited{color:#689d6a;background-color:initial;text-decoration:none}nav.toc a:hover{color:#8ec07c;background-color:initial;text-decoration:none}nav.toc a:active{color:#8ec07c;background-color:initial;text-decoration:underline}.sidenote,marginnote{width:20rem;clear:right;font-size:1.1rem;line-height:1.3;vertical-align:baseline}body{counter-set:sidenote-counter}.sidenote-number{counter-increment:sidenote-counter}.sidenote:before{content:counter(sidenote-counter)" ";position:relative;vertical-align:baseline;font-weight:700;font-size:1rem;top:-.5rem;font-size:.9em}.sidenote-number:after{content:counter(sidenote-counter);position:relative;vertical-align:baseline;font-weight:700;font-size:1rem;top:-.5rem;left:.1rem}blockquote .sidenote,blockquote .marginnote{margin-right:82%;min-width:59%;text-align:left}.sidenote>code{font-size:1rem}label.sidenote-number{display:inline-block;max-height:2rem}label.margin-toggle:not(.sidenote-number){display:none}input.margin-toggle{display:none}@media all and (max-width:1439px){nav.toc{display:none}}@media all and (max-width:1439px){.sidenote,.marginnote{float:right;text-align:left;margin:1rem 0;padding-left:5%}}@media all and (min-width:1440px){.sidenote,.marginnote{float:right;margin-right:-30%;margin-top:.3rem;margin-bottom:0;position:relative}}@media all and (max-width:639px){body{width:100%;margin:0;padding:0 5%}header{margin:1rem 0}nav.header{margin:.5rem auto;text-align:center}footer{text-align:center}nav.header a{font-size:1.4rem;line-height:1.6}.logo{font-size:1.8rem}nav.header a{margin:0 .6rem}}@media all and (min-width:640px){body{width:70rem;margin:0 auto;padding:0}header{margin:0 0 3rem;padding:.6rem 0 .2rem}nav.header{display:flex;align-items:flex-end;justify-content:space-between;margin:0;text-align:right}nav.header a{font-size:1.8rem;margin:0 0 0 .6rem;display:inline}.navigation{justify-content:flex-end}footer{text-align:right}.logo{margin:0;text-align:left;font-size:2.4rem}}pre{line-height:125%}td.linenos .normal{color:#3c4354;background-color:initial;padding-left:5px;padding-right:5px}span.linenos{color:#3c4354;background-color:initial;padding-left:5px;padding-right:5px}td.linenos .special{color:#3c4354;background-color:#ffffc0;padding-left:5px;padding-right:5px}span.linenos.special{color:#3c4354;background-color:#ffffc0;padding-left:5px;padding-right:5px}.hll{background-color:#6e7681}.c{color:#7e8aa1}.err{color:#f88f7f}.esc{color:#d4d2c8}.g{color:#d4d2c8}.k{color:#ffad66}.l{color:#d5ff80}.n{color:#d4d2c8}.o{color:#ffad66}.x{color:#d4d2c8}.p{color:#d4d2c8}.ch{color:#f88f7f;font-style:italic}.cm{color:#7e8aa1}.cp{color:#ffad66;font-weight:700}.cpf{color:#7e8aa1}.c1{color:#7e8aa1}.cs{color:#7e8aa1;font-style:italic}.gd{color:#f88f7f;background-color:#3d1e20}.ge{color:#d4d2c8;font-style:italic}.ges{color:#d4d2c8}.gr{color:#f88f7f}.gh{color:#d4d2c8}.gi{color:#6ad4af;background-color:#19362c}.go{color:#7e8aa1}.gp{color:#d4d2c8}.gs{color:#d4d2c8;font-weight:700}.gu{color:#d4d2c8}.gt{color:#f88f7f}.kc{color:#ffad66}.kd{color:#ffad66}.kn{color:#ffad66}.kp{color:#ffad66}.kr{color:#ffad66}.kt{color:#73d0ff}.ld{color:#d5ff80}.m{color:#dfbfff}.s{color:#d5ff80}.na{color:#ffd173}.nb{color:#ffd173}.nc{color:#73d0ff}.no{color:#ffd173}.nd{color:#7e8aa1;font-weight:700;font-style:italic}.ni{color:#95e6cb}.ne{color:#73d0ff}.nf{color:#ffd173}.nl{color:#d4d2c8}.nn{color:#d4d2c8}.nx{color:#d4d2c8}.py{color:#ffd173}.nt{color:#5ccfe6}.nv{color:#d4d2c8}.ow{color:#ffad66}.pm{color:#d4d2c8}.w{color:#d4d2c8}.mb{color:#dfbfff}.mf{color:#dfbfff}.mh{color:#dfbfff}.mi{color:#dfbfff}.mo{color:#dfbfff}.sa{color:#f29e74}.sb{color:#d5ff80}.sc{color:#d5ff80}.dl{color:#d5ff80}.sd{color:#7e8aa1}.s2{color:#d5ff80}.se{color:#95e6cb}.sh{color:#d5ff80}.si{color:#95e6cb}.sx{color:#95e6cb}.sr{color:#95e6cb}.s1{color:#d5ff80}.ss{color:#dfbfff}.bp{color:#5ccfe6}.fm{color:#ffd173}.vc{color:#d4d2c8}.vg{color:#d4d2c8}.vi{color:#d4d2c8}.vm{color:#d4d2c8}.il{color:#dfbfff}</style><link rel=preload href=../css/fonts/Montserrat-e561391.woff2 crossorigin=anonymous as=font type=font/woff2><link rel=stylesheet href=../css/katex.css media=print onload='this.media="all"'><noscript><link rel=stylesheet href=../css/katex.css></noscript><link rel="shortcut icon" href=favicon.ico type=image/x-icon><link rel="shortcut icon" href=../images/favicons/favicon32.png><link rel=apple-touch-icon-precomposed sizes=144x144 href=../images/favicons/favicon144.png><link rel=apple-touch-icon-precomposed sizes=114x114 href=../images/favicons/favicon114.png><link rel=apple-touch-icon-precomposed sizes=72x72 href=../images/favicons/favicon72.png><link rel=apple-touch-icon-precomposed sizes=57x57 href=../images/favicons/favicon57.png><header><nav class=header><a class=logo href=../>(Non-)Functional Ramblings</a><div class=navigation><a href=../about.html>About</a>
<a href=../static/resume.pdf>Resume</a>
<a href=../archive.html>Archive</a>
<a href=../atom.xml>Feed</a></div></nav></header><main role=main><h1 class=title>Lazy-ing in My Pool</h1><article><section class=publish-date><em>Posted on October 6, 2024</em></section><section><p></p>I encountered an interesting problem recently, where I needed to initialize a pool of resources. The caveat here is though, for performance reasons, I only wanted to initialize resources on demand. Mainly to avoid paying the price of initializing the entire pool, when I might only need to do a singular action using one resource.<p></p>Everyone likes a nice usecase, so let’s set the scene. Imagine you have a pool of files you need to read over the network, and some work you have to do on each file’s contents. This <code>FileHandle</code> is the resource we’ll manage manually, ensuring the connections is properly both, initialized and finalized.<div class=highlight><pre tabindex=0><span></span><span class=kr>data</span><span class=w> </span><span class=kt>FileHandle</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=kt>FileHandle</span><span class=w> </span><span class=p>{</span><span class=o>...</span><span class=p>}</span>

<span class=nf>doWork</span><span class=w> </span><span class=ow>::</span><span class=w> </span><span class=kt>FileHandle</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>IO</span><span class=w> </span><span class=kt>Int</span>
<span class=nf>doWork</span><span class=w> </span><span class=n>fileHandle</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=n>readArguments</span><span class=w> </span><span class=n>fileHandle</span><span class=w> </span><span class=o>&gt;&gt;=</span><span class=w> </span><span class=n>process</span>
</pre></div><h2 id=explicit-lazy-resources>Explicit Lazy Resources</h2><p></p>Let’s start with initializing a single one of these <code>FileHandle</code> resource lazily, and only afterwards create a pool from there. Doing anything with resources implies using something like <code>bracket</code> to ensure finalization in the presence of exceptions. Though <code>bracket</code> isn’t enough by itself in this case, as <code>bracket</code> implies strict usage of the resource. What we can do, however, is create an explicitly lazy wrapper around our initialization and use that as the resource within <code>bracket</code> instead.<div class=highlight><pre tabindex=0><span></span><span class=kr>data</span><span class=w> </span><span class=kt>LazyResource</span><span class=w> </span><span class=n>m</span><span class=w> </span><span class=n>a</span>
<span class=w>    </span><span class=ow>=</span><span class=w> </span><span class=kt>Uninitialized</span><span class=w> </span><span class=p>(</span><span class=n>m</span><span class=w> </span><span class=n>a</span><span class=p>)</span>
<span class=w>    </span><span class=o>|</span><span class=w> </span><span class=kt>Initialized</span><span class=w> </span><span class=n>a</span>
<span class=w>    </span><span class=o>|</span><span class=w> </span><span class=kt>Finalized</span>
</pre></div><p></p>We’ll need something extra to maintain what state the resource currently exists in, however. We could do something <code>State</code>-style and do <code>LazyResource a -> (LazyResource a, r)</code>, but while concrete, that’s not very user friendly, and also does nothing for thread-safety, if we want to use this resource concurrently. A simple alternatively is to encase the lazy wrapper and persist the resource’s state in an <code>MVar</code> cell.<div class=highlight><pre tabindex=0><span></span><span class=c1>-- | Anytime we use the resource, we trigger the deferred the initialization.</span>
<span class=nf>withLazyResource</span><span class=w> </span><span class=ow>::</span><span class=w> </span><span class=kt>MVar</span><span class=w> </span><span class=p>(</span><span class=kt>LazyResource</span><span class=w> </span><span class=n>a</span><span class=p>)</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=p>(</span><span class=n>a</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>IO</span><span class=w> </span><span class=n>r</span><span class=p>)</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>IO</span><span class=w> </span><span class=n>r</span>
<span class=nf>withLazyResource</span><span class=w> </span><span class=n>lazyResourceRef</span><span class=w> </span><span class=n>continuation</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=n>mask</span><span class=w> </span><span class=o>$</span><span class=w> </span><span class=nf>\</span><span class=n>restore</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kr>do</span>
<span class=w>  </span><span class=n>lazyResource</span><span class=w> </span><span class=ow>&lt;-</span><span class=w> </span><span class=n>takeMVar</span><span class=w> </span><span class=n>lazyResourceRef</span>
<span class=w>  </span><span class=c1>-- We always have to ensure we put back the resource into the cell, to ensure</span>
<span class=w>  </span><span class=c1>-- any waiting, are unblocked</span>
<span class=w>  </span><span class=kr>let</span><span class=w> </span><span class=n>putBackVerbatim</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=n>putMVar</span><span class=w> </span><span class=n>lazyResourceRef</span><span class=w> </span><span class=n>lazyResource</span>
<span class=w>  </span><span class=n>resource</span><span class=w> </span><span class=ow>&lt;-</span><span class=w> </span><span class=kr>case</span><span class=w> </span><span class=n>lazyResource</span><span class=w> </span><span class=kr>of</span>
<span class=w>    </span><span class=kt>Uninitialized</span><span class=w> </span><span class=n>initializer</span><span class=w> </span><span class=ow>-&gt;</span>
<span class=w>      </span><span class=n>restore</span><span class=w> </span><span class=n>initializer</span><span class=w> </span><span class=p>`</span><span class=n>onException</span><span class=p>`</span><span class=w> </span><span class=n>putBackVerbatim</span>
<span class=w>    </span><span class=kt>Initialized</span><span class=w> </span><span class=n>resource</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=n>pure</span><span class=w> </span><span class=n>resource</span>
<span class=w>    </span><span class=kt>Finalized</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kr>do</span>
<span class=w>      </span><span class=n>putBackVerbatim</span>
<span class=w>      </span><span class=ne>error</span><span class=w> </span><span class=s>&quot;Attempted to use a resource after it has been finalized&quot;</span>

<span class=w>  </span><span class=c1>-- Same as the above, but we've now initialized the resource.</span>
<span class=w>  </span><span class=kr>let</span><span class=w> </span><span class=n>putInitialized</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=n>putMVar</span><span class=w> </span><span class=n>lazyResourceRef</span><span class=w> </span><span class=p>(</span><span class=kt>Initialized</span><span class=w> </span><span class=n>resource</span><span class=p>)</span>
<span class=w>  </span><span class=n>result</span><span class=w> </span><span class=ow>&lt;-</span><span class=w> </span><span class=n>restore</span><span class=w> </span><span class=p>(</span><span class=n>continuation</span><span class=w> </span><span class=n>resource</span><span class=p>)</span><span class=w> </span><span class=p>`</span><span class=n>onException</span><span class=p>`</span><span class=w> </span><span class=n>putInitialized</span>
<span class=w>  </span><span class=n>putInitialized</span>
<span class=w>  </span><span class=n>pure</span><span class=w> </span><span class=n>result</span>
</pre></div><p></p>Some care has to be taken when exceptions are involved, and to ensure that the <code>MVar</code> is never left empty, even while initializing the resource in the first place! It is preferable that every thread depending on the resource fails, instead of being deadlocked on the thread that held the resource and died.<p></p>Creating one of these <code>MVar (LazyResource FileHandle)</code> is left as an exercise to the reader. It should take care of deferring both the initialization as well as finalization of the underlying resource, if needed.<h2 id=lazy-pools>Lazy Pools</h2><p></p>Creating pools of these lazy resources is not much different than pools of any manually managed resources, ensuring that each initialization is paired with a corresponding finalization. In actuality, you’ll likely want something that already exists like <a href=https://hackage.haskell.org/package/resource-pool>resource-pool</a>. But I’ll show a small simple alternative.<p></p>Keeping it simple, I’ll keep track of all resources in the pool in a simple list, along with a quantity semaphore that ensures we don’t exceed the intended number of resources.<div class=highlight><pre tabindex=0><span></span><span class=kr>data</span><span class=w> </span><span class=kt>Pool</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=kt>Pool</span>
<span class=w>  </span><span class=p>{</span><span class=w> </span><span class=n>resources</span><span class=w> </span><span class=ow>::</span><span class=w> </span><span class=kt>IORef</span><span class=w> </span><span class=p>[</span><span class=n>a</span><span class=p>]</span>
<span class=w>  </span><span class=p>,</span><span class=w> </span><span class=n>occupancy</span><span class=w> </span><span class=ow>::</span><span class=w> </span><span class=kt>QSem</span>
<span class=w>  </span><span class=p>}</span>
</pre></div><p></p>For nesting consecutive <code>with</code>-like functions, there’s a neat trick you can do with <code>kan-extensions</code>’ <code>Codensity</code> type.<div class=highlight><pre tabindex=0><span></span><span class=nf>withPool</span>
<span class=w>  </span><span class=ow>::</span><span class=w> </span><span class=p>(</span><span class=n>forall</span><span class=w> </span><span class=n>r</span><span class=o>.</span><span class=w> </span><span class=p>(</span><span class=n>a</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>IO</span><span class=w> </span><span class=n>r</span><span class=p>)</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>IO</span><span class=w> </span><span class=n>r</span><span class=p>)</span>
<span class=w>  </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>Int</span>
<span class=w>  </span><span class=ow>-&gt;</span><span class=w> </span><span class=p>(</span><span class=kt>Pool</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>IO</span><span class=w> </span><span class=n>b</span><span class=p>)</span>
<span class=w>  </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>IO</span><span class=w> </span><span class=n>b</span>
<span class=nf>withPool</span><span class=w> </span><span class=n>withResource</span><span class=w> </span><span class=n>poolSize</span><span class=w> </span><span class=n>action</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=kr>do</span>
<span class=w>  </span><span class=kr>let</span><span class=w> </span><span class=n>withPoolResources</span><span class=w> </span><span class=ow>=</span>
<span class=w>        </span><span class=n>runCodensity</span><span class=w> </span><span class=o>$</span><span class=w> </span><span class=n>replicateM</span><span class=w> </span><span class=n>poolSize</span><span class=w> </span><span class=o>$</span><span class=w> </span><span class=kt>Codensity</span><span class=w> </span><span class=n>withResource</span>

<span class=w>  </span><span class=n>withPoolResources</span><span class=w> </span><span class=o>$</span><span class=w> </span><span class=nf>\</span><span class=n>resources</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kr>do</span>
<span class=w>    </span><span class=n>poolResources</span><span class=w> </span><span class=ow>&lt;-</span><span class=w> </span><span class=n>newIORef</span><span class=w> </span><span class=n>resources</span>
<span class=w>    </span><span class=n>qSem</span><span class=w> </span><span class=ow>&lt;-</span><span class=w> </span><span class=n>newQSem</span><span class=w> </span><span class=n>poolSize</span>
<span class=w>    </span><span class=n>action</span><span class=w> </span><span class=o>$</span><span class=w> </span><span class=kt>Pool</span><span class=w> </span><span class=n>poolResources</span><span class=w> </span><span class=n>qSem</span>
</pre></div><p></p>That’s it! Using the pool is should be straightforward, keeping the resources in the pool and the semaphore in sync, while masking exceptions via <code>bracket</code>. And it can be combined with <code>withLazyResource</code> to handle lazy resources transparently.</section></article></main><footer>Site proudly generated by <a href=http://jaspervdj.be/hakyll>Hakyll</a>.
All content is licensed under <a href=../LICENSE.txt>3-clause BSD license</a>.</footer>