<!doctype html><html lang=en><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="An exercise in parameterizing tasty test-suites using the CLI."><title>(Non-)Functional Ramblings - Tastier Options</title><style>@font-face{font-family:fira code;font-style:normal;font-weight:300 700;font-display:swap;src:local("Fira Code"),local("FiraCode"),url(/css/fonts/FiraCode-b0dcd4e.woff2)format('woff2-variations')}@font-face{font-family:montserrat;font-style:normal;font-weight:100 900;font-display:swap;src:local("Montserrat"),url(/css/fonts/Montserrat-b0dcd4e.woff2)format('woff2-variations')}@font-face{font-family:montserrat;font-style:italic;font-weight:100 900;font-display:swap;src:local("Montserrat Italic"),local("Montserrat-Italic"),url(/css/fonts/Montserrat-Italic-b0dcd4e.woff2)format('woff2-variations')}html{font-size:80%;font-weight:400;font-family:montserrat,arial,sans-serif;scroll-behavior:smooth;scrollbar-gutter:stable}html{text-size-adjust:none}*,*::before,*::after{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;-ms-box-sizing:border-box;-o-box-sizing:border-box;box-sizing:border-box}body{line-height:1.5;-webkit-font-smoothing:antialiased}input,button,textarea,select{font:inherit}p,h1,h2,h3,h4,h5,h6{overflow-wrap:break-word}#root,#__next{isolation:isolate}body{font-size:1.6rem;background-color:#282828;color:#fbf1c7}code,pre{background-color:#1d2021}header{border-bottom:.2rem solid #98971a}nav a{font-weight:700;text-decoration:none}body img{max-width:100%;max-height:100%;display:block;margin:auto;height:auto;width:auto}body figcaption{text-align:center}footer{margin-top:3rem;padding:1.2rem 0;border-top:.2rem solid #98971a;font-size:1.2rem;color:#fbf1c7}h1{font-size:2.4rem}h2{font-size:2rem}h3{font-size:1.8rem}h4{font-size:1.6rem}.title{margin-bottom:0}article .publish-date{margin:0 0 2rem 1rem;font-size:1.4rem;color:#fbf1c7}article .last-modified-date{font-size:1rem}.logo a{font-weight:700;color:#fbf1c7;text-decoration:none}html{scrollbar-width:thick;scrollbar-color:#928374 #282828}pre{scrollbar-width:thin;scrollbar-color:#928374 #282828}nav.toc{float:left;clear:left;font-size:2rem;margin-left:-28%;width:20rem;word-wrap:break-word;padding:1rem;vertical-align:baseline;position:-webkit-sticky;position:sticky;top:5vh}nav.toc a{font-size:1.4rem}nav.toc ::marker{margin:0 -1rem 0 0}nav.toc li{margin:0;padding:0;line-height:1.2}nav.toc .toc-header{font-weight:700}nav.toc ul li{list-style-position:outside}nav.toc ul{margin-top:0;margin-bottom:0}pre,code{width:100%;font-family:fira code,consolas,monospace}div.highlight.inline{display:inline}pre{white-space:pre;overflow:auto;margin:1rem 0;background-color:#1d2021;padding:1rem;border-radius:.5rem .5rem .5rem .5rem}code{word-break:break-word;padding:0 .4rem;border-radius:.3rem .3rem .3rem .3rem}html a:link{color:#689d6a;background-color:initial;text-decoration:underline}html a:visited{color:#689d6a;background-color:initial;text-decoration:underline}html a:hover{color:#8ec07c;background-color:initial;text-decoration:underline}html a:active{color:#8ec07c;background-color:initial;text-decoration:none}nav.header a:link{color:#689d6a;background-color:initial;text-decoration:none}nav.header a:visited{color:#689d6a;background-color:initial;text-decoration:none}nav.header a:hover{color:#8ec07c;background-color:initial;text-decoration:none}nav.header a:active{color:#8ec07c;background-color:initial;text-decoration:underline}nav.toc a:link{color:#689d6a;background-color:initial;text-decoration:none}nav.toc a:visited{color:#689d6a;background-color:initial;text-decoration:none}nav.toc a:hover{color:#8ec07c;background-color:initial;text-decoration:none}nav.toc a:active{color:#8ec07c;background-color:initial;text-decoration:underline}.sidenote,marginnote{width:20rem;clear:right;font-size:1.1rem;line-height:1.3;vertical-align:baseline}body{counter-set:sidenote-counter}.sidenote-number{counter-increment:sidenote-counter}.sidenote:before{content:counter(sidenote-counter)" ";position:relative;vertical-align:baseline;font-weight:700;font-size:1rem;top:-.5rem;font-size:.9em}.sidenote-number:after{content:counter(sidenote-counter);position:relative;vertical-align:baseline;font-weight:700;font-size:1rem;top:-.5rem;left:.1rem}blockquote .sidenote,blockquote .marginnote{margin-right:82%;min-width:59%;text-align:left}.sidenote>code{font-size:1rem}label.sidenote-number{display:inline-block;max-height:2rem}label.margin-toggle:not(.sidenote-number){display:none}input.margin-toggle{display:none}.post-list{margin-top:1rem}.post-list-item{margin-bottom:2rem}.post-list-item p{width:100%;margin:0}.post-description{padding-top:.5rem}.post-header-title{text-align:left}.post-header-date{text-align:right}@media all and (max-width:1439px){nav.toc{display:none}}@media all and (max-width:1439px){.sidenote,.marginnote{float:right;text-align:left;margin:1rem 0;padding-left:5%}}@media all and (min-width:1440px){.sidenote,.marginnote{float:right;margin-right:-30%;margin-top:.3rem;margin-bottom:0;position:relative}}@media all and (max-width:639px){body{width:100%;margin:0;padding:0 5%}header{margin:1rem 0}nav.header{margin:.5rem auto;text-align:center}footer{text-align:center}nav.header a{font-size:1.4rem;line-height:1.6}.logo{font-size:1.8rem}nav.header a{margin:0 .6rem}}@media all and (min-width:640px){body{width:70rem;margin:0 auto;padding:0}header{margin:0 0 3rem;padding:.6rem 0 .2rem}nav.header{display:flex;align-items:flex-end;justify-content:space-between;margin:0;text-align:right}nav.header a{font-size:1.8rem;margin:0 0 0 .6rem;display:inline}.navigation{justify-content:flex-end}footer{text-align:right}.logo{margin:0;text-align:left;font-size:2.4rem}}@media all and (max-width:1439px){.post-header{display:block}}@media all and (min-width:1440px){.post-header{display:flex}.post-header-title{padding-left:1rem}.post-description{padding-left:3rem;padding-top:.5rem}}pre{line-height:125%}td.linenos .normal{color:#3c4354;background-color:initial;padding-left:5px;padding-right:5px}span.linenos{color:#3c4354;background-color:initial;padding-left:5px;padding-right:5px}td.linenos .special{color:#3c4354;background-color:#ffffc0;padding-left:5px;padding-right:5px}span.linenos.special{color:#3c4354;background-color:#ffffc0;padding-left:5px;padding-right:5px}.hll{background-color:#6e7681}.c{color:#7e8aa1}.err{color:#f88f7f}.esc{color:#d4d2c8}.g{color:#d4d2c8}.k{color:#ffad66}.l{color:#d5ff80}.n{color:#d4d2c8}.o{color:#ffad66}.x{color:#d4d2c8}.p{color:#d4d2c8}.ch{color:#f88f7f;font-style:italic}.cm{color:#7e8aa1}.cp{color:#ffad66;font-weight:700}.cpf{color:#7e8aa1}.c1{color:#7e8aa1}.cs{color:#7e8aa1;font-style:italic}.gd{color:#f88f7f;background-color:#3d1e20}.ge{color:#d4d2c8;font-style:italic}.ges{color:#d4d2c8}.gr{color:#f88f7f}.gh{color:#d4d2c8}.gi{color:#6ad4af;background-color:#19362c}.go{color:#7e8aa1}.gp{color:#d4d2c8}.gs{color:#d4d2c8;font-weight:700}.gu{color:#d4d2c8}.gt{color:#f88f7f}.kc{color:#ffad66}.kd{color:#ffad66}.kn{color:#ffad66}.kp{color:#ffad66}.kr{color:#ffad66}.kt{color:#73d0ff}.ld{color:#d5ff80}.m{color:#dfbfff}.s{color:#d5ff80}.na{color:#ffd173}.nb{color:#ffd173}.nc{color:#73d0ff}.no{color:#ffd173}.nd{color:#7e8aa1;font-weight:700;font-style:italic}.ni{color:#95e6cb}.ne{color:#73d0ff}.nf{color:#ffd173}.nl{color:#d4d2c8}.nn{color:#d4d2c8}.nx{color:#d4d2c8}.py{color:#ffd173}.nt{color:#5ccfe6}.nv{color:#d4d2c8}.ow{color:#ffad66}.pm{color:#d4d2c8}.w{color:#d4d2c8}.mb{color:#dfbfff}.mf{color:#dfbfff}.mh{color:#dfbfff}.mi{color:#dfbfff}.mo{color:#dfbfff}.sa{color:#f29e74}.sb{color:#d5ff80}.sc{color:#d5ff80}.dl{color:#d5ff80}.sd{color:#7e8aa1}.s2{color:#d5ff80}.se{color:#95e6cb}.sh{color:#d5ff80}.si{color:#95e6cb}.sx{color:#95e6cb}.sr{color:#95e6cb}.s1{color:#d5ff80}.ss{color:#dfbfff}.bp{color:#5ccfe6}.fm{color:#ffd173}.vc{color:#d4d2c8}.vg{color:#d4d2c8}.vi{color:#d4d2c8}.vm{color:#d4d2c8}.il{color:#dfbfff}</style><link rel=preload href=../css/fonts/Montserrat-b0dcd4e.woff2 crossorigin=anonymous as=font type=font/woff2><link rel=stylesheet href=../css/katex.css media=print onload='this.media="all"'><noscript><link rel=stylesheet href=../css/katex.css></noscript><link rel="shortcut icon" href=favicon.ico type=image/x-icon><link rel="shortcut icon" href=../images/favicons/favicon32.png><link rel=apple-touch-icon-precomposed sizes=144x144 href=../images/favicons/favicon144.png><link rel=apple-touch-icon-precomposed sizes=114x114 href=../images/favicons/favicon114.png><link rel=apple-touch-icon-precomposed sizes=72x72 href=../images/favicons/favicon72.png><link rel=apple-touch-icon-precomposed sizes=57x57 href=../images/favicons/favicon57.png><header><nav class=header><a class=logo href=../>(Non-)Functional Ramblings</a><div class=navigation><a href=../about.html>About</a>
<a href=../static/resume.pdf>Resume</a>
<a href=../archive.html>Archive</a>
<a href=../atom.xml>Feed</a></div></nav></header><main role=main><h1 class=title>Tastier Options</h1><article><section class=publish-date><em>Posted on December 19, 2025</em></section><section><p></p>I encountered a pretty simple problem recently, or how it’s probably
better phrased, I recently made my life a bit harder by thinking:
“What if?”. I needed to pass multiple arguments via the CLI to a
<a href=https://hackage-content.haskell.org/package/tasty-1.5.3>tasty</a> test-suite
to use in some tests. As an example, I’ll pass the connection string to use to
connect to a PostgreSQL database. That could go something like the following.<p></p>Typically, you’d tell tasty about the existence of your new option via
<a href=https://hackage-content.haskell.org/package/tasty-1.5.3/docs/Test-Tasty.html#v:includingOptions><code>includingOptions</code></a>, and then access these options via
<a href=https://hackage-content.haskell.org/package/tasty-1.5.3/docs/Test-Tasty.html#v:askOption><code>askOption</code></a>.<div class=highlight><pre tabindex=0><span></span><span class=c1>-- Create the option in the style of tasty.</span>
<span class=kr>data</span><span class=w> </span><span class=kt>PgConnectionString</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=kt>PgConnectionString</span><span class=w> </span><span class=kt>Text</span>
<span class=kr>instance</span><span class=w> </span><span class=kt>IsOption</span><span class=w> </span><span class=kt>PgConnectionString</span><span class=w> </span><span class=kr>where</span><span class=w> </span><span class=o>...</span>

<span class=c1>-- `defaultMainWithIngredients` gives us an ingredient to</span>
<span class=c1>-- plug the option into, so it gets shown in the CLI.</span>
<span class=nf>main</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=kr>do</span>
<span class=w>  </span><span class=n>defaultMainWithIngredients</span>
<span class=w>    </span><span class=p>[</span><span class=w> </span><span class=n>includingOptions</span><span class=w> </span><span class=p>[</span><span class=kt>Option</span><span class=w> </span><span class=p>(</span><span class=kt>Proxy</span><span class=w> </span><span class=o>@</span><span class=kt>PgConnectionString</span><span class=p>)]</span>
<span class=w>    </span><span class=p>]</span><span class=w> </span><span class=o>$</span><span class=w> </span><span class=n>askOption</span><span class=w> </span><span class=n>setupTests</span>

<span class=c1>-- `askOption` propogates it so we can setup our test-suite</span>
<span class=c1>-- to make the appropriate calls.</span>
<span class=nf>setupTests</span><span class=w> </span><span class=ow>::</span><span class=w> </span><span class=kt>PgConnectionString</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>TestTree</span>
<span class=nf>setupTests</span><span class=w> </span><span class=kr>_</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=n>undefined</span>
</pre></div><p></p>That’s all nice and all, but the querying doesn’t really extend in a nice way.
Concretely, I’d need to call <code>askOption</code> for each individual option I’d want to
add to my <code>setupTests</code> function.<div class=highlight><pre tabindex=0><span></span><span class=kr>data</span><span class=w> </span><span class=kt>PgPoolSize</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=kt>PgPoolSize</span><span class=w> </span><span class=kt>Text</span>
<span class=kr>instance</span><span class=w> </span><span class=kt>IsOption</span><span class=w> </span><span class=kt>PgPoolSize</span><span class=w> </span><span class=kr>where</span><span class=w> </span><span class=o>...</span>

<span class=nf>main</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=kr>do</span>
<span class=w>  </span><span class=n>defaultMainWithIngredients</span>
<span class=w>    </span><span class=p>[</span><span class=w> </span><span class=n>includingOptions</span>
<span class=w>      </span><span class=p>[</span><span class=w> </span><span class=kt>Option</span><span class=w> </span><span class=p>(</span><span class=kt>Proxy</span><span class=w> </span><span class=o>@</span><span class=kt>PgConnectionString</span><span class=p>)</span>
<span class=w>      </span><span class=p>,</span><span class=w> </span><span class=kt>Option</span><span class=w> </span><span class=p>(</span><span class=kt>Proxy</span><span class=w> </span><span class=o>@</span><span class=kt>PgPoolSize</span><span class=p>)</span>
<span class=w>      </span><span class=p>]</span>
<span class=w>    </span><span class=p>]</span><span class=w> </span><span class=o>$</span>
<span class=w>      </span><span class=n>askOption</span><span class=w> </span><span class=o>$</span><span class=w> </span><span class=nf>\</span><span class=p>(</span><span class=n>connectionString</span><span class=w> </span><span class=ow>::</span><span class=w> </span><span class=kt>PgConnectionString</span><span class=p>)</span><span class=w> </span><span class=ow>-&gt;</span>
<span class=w>        </span><span class=n>askOption</span><span class=w> </span><span class=o>$</span><span class=w> </span><span class=nf>\</span><span class=p>(</span><span class=n>poolSize</span><span class=w> </span><span class=ow>::</span><span class=w> </span><span class=kt>PgPoolSize</span><span class=p>)</span><span class=w> </span><span class=ow>-&gt;</span>
<span class=w>          </span><span class=n>setupTests</span><span class=w> </span><span class=n>connectionString</span><span class=w> </span><span class=n>poolSize</span>
</pre></div><p></p>What if I could write a helper that did this passing around of options for me
for free?<div class=highlight><pre tabindex=0><span></span><span class=nf>main</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=kr>do</span>
<span class=w>    </span><span class=n>defaultMainWithIngredients</span>
<span class=w>      </span><span class=p>[</span><span class=w> </span><span class=n>includingOptions</span>
<span class=w>        </span><span class=p>[</span><span class=w> </span><span class=kt>Option</span><span class=w> </span><span class=p>(</span><span class=kt>Proxy</span><span class=w> </span><span class=o>@</span><span class=kt>PgConnectionString</span><span class=p>)</span>
<span class=w>        </span><span class=p>,</span><span class=w> </span><span class=kt>Option</span><span class=w> </span><span class=p>(</span><span class=kt>Proxy</span><span class=w> </span><span class=o>@</span><span class=kt>PgPoolSize</span><span class=p>)</span>
<span class=w>        </span><span class=p>]</span>
<span class=w>      </span><span class=p>]</span><span class=w> </span><span class=o>$</span><span class=w> </span><span class=n>withTests</span><span class=w> </span><span class=n>setupTests</span>
</pre></div><p></p>As has been a recurring pattern in a few of my posts, variadic functions come to
the rescue! We want to build up a variadic continuation (<a href=../posts/functional-programmers-enter-a-diner.html>like last
time</a>) that
<code>setupTests</code> can be passed to. In this case we want instance resolution to keep
adding arguments via <code>askOption</code> at each resolution step.<p></p>Continuation functions generally have the pattern of <code>forall c. (a -> c) -> c</code>,
and considering we’re intending on giving this function our test setup, some
good intuition (or practical experimentation) gives something of the form
<code>forall r. ((a -> c) -> r) -> r</code>. Here <code>a</code> will play the role of capturing more
and more options, and <code>c</code> will capture the <code>TestTree</code>. <label for=sn-0 class="margin-toggle sidenote-number"></label><input type=checkbox id=sn-0 class=margin-toggle><div class=sidenote>I’m not super sure, but I feel like there’s a simpler alternative
here that either reduces the number of arrows or the number of type variables
in the type class. I kept hitting my head on trying to find a simpler
representation though.</div><div class=highlight><pre tabindex=0><span></span><span class=kr>class</span><span class=w> </span><span class=kt>WithOptions</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=kr>where</span>
<span class=w>  </span><span class=n>withOptions_</span><span class=w> </span><span class=ow>::</span><span class=w> </span><span class=n>forall</span><span class=w> </span><span class=n>r</span><span class=o>.</span><span class=w> </span><span class=p>((</span><span class=n>a</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=n>c</span><span class=p>)</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=n>r</span><span class=p>)</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=n>r</span>

<span class=kr>instance</span><span class=w> </span><span class=kt>WithOptions</span><span class=w> </span><span class=kt>TestTree</span><span class=w> </span><span class=kt>TestTree</span><span class=w> </span><span class=kr>where</span>
<span class=w>  </span><span class=n>withOptions_</span><span class=w> </span><span class=n>f</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=n>f</span><span class=w> </span><span class=n>identity</span>

<span class=kr>instance</span><span class=w> </span><span class=p>(</span><span class=kt>IsOption</span><span class=w> </span><span class=n>o</span><span class=p>,</span><span class=w> </span><span class=kt>WithOptions</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=kt>TestTree</span><span class=p>)</span>
<span class=w>    </span><span class=ow>=&gt;</span><span class=w> </span><span class=kt>WithOptions</span><span class=w> </span><span class=p>(</span><span class=n>o</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=n>c</span><span class=p>)</span><span class=w> </span><span class=kt>TestTree</span><span class=w> </span><span class=kr>where</span>
<span class=w>  </span><span class=n>withOptions_</span><span class=w> </span><span class=n>outer</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=n>withOptions_</span><span class=w> </span><span class=o>$</span>
<span class=w>    </span><span class=nf>\</span><span class=n>next</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=n>outer</span><span class=w> </span><span class=o>$</span><span class=w> </span><span class=nf>\</span><span class=n>inner</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=n>askOption</span><span class=w> </span><span class=o>$</span>
<span class=w>      </span><span class=nf>\</span><span class=n>option</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=n>next</span><span class=w> </span><span class=p>(</span><span class=n>inner</span><span class=w> </span><span class=n>option</span><span class=p>)</span>
</pre></div><p></p>A nice benefit of these variadic functions is, once you’ve found your core
definition and how the incremental step should be setup, the implementation
flows out of the type variables you’ve used. In this case the base case of the
continuation is the identity function, and in the incremental step, we call
<code>askOption</code> with the appropriate type. This gives the very nice final interface
of…<div class=highlight><pre tabindex=0><span></span><span class=nf>withOptions</span><span class=w> </span><span class=ow>::</span><span class=w> </span><span class=kt>WithOptions</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=kt>TestTree</span><span class=w> </span><span class=ow>=&gt;</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>TestTree</span>
<span class=nf>withOptions</span><span class=w> </span><span class=n>f</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=n>withOptions_</span><span class=w> </span><span class=o>$</span><span class=w> </span><span class=nf>\</span><span class=n>addOptions</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=n>addOptions</span><span class=w> </span><span class=n>f</span>

<span class=nf>main</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=kr>do</span>
<span class=w>  </span><span class=n>defaultMainWithIngredients</span>
<span class=w>    </span><span class=p>[</span><span class=w> </span><span class=n>includingOptions</span>
<span class=w>      </span><span class=p>[</span><span class=w> </span><span class=kt>Option</span><span class=w> </span><span class=p>(</span><span class=kt>Proxy</span><span class=w> </span><span class=o>@</span><span class=kt>PgConnectionString</span><span class=p>)</span>
<span class=w>      </span><span class=p>,</span><span class=w> </span><span class=kt>Option</span><span class=w> </span><span class=p>(</span><span class=kt>Proxy</span><span class=w> </span><span class=o>@</span><span class=kt>PgPoolSize</span><span class=p>)</span>
<span class=w>      </span><span class=p>]</span>
<span class=w>    </span><span class=p>]</span><span class=w> </span><span class=o>$</span><span class=w> </span><span class=n>withOptions</span><span class=w> </span><span class=n>setupTests</span>
</pre></div></section></article></main><footer>Site proudly generated by <a href=http://jaspervdj.be/hakyll>Hakyll</a>.
All content is licensed under <a href=../LICENSE.txt>3-clause BSD license</a>.</footer>