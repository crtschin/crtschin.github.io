<!doctype html><html lang=en><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="A fun, I think, thought experiment to avoid concurrency deadlocks by enforcing a fixed, predefined order for acquiring static sets of MVars."><title>(Non-)Functional Ramblings - Functional programmers enter a diner…</title><style>@font-face{font-family:fira code;font-style:normal;font-weight:300 700;font-display:swap;src:local("Fira Code"),local("FiraCode"),url(/css/fonts/FiraCode-69a5c2d.woff2)format('woff2-variations')}@font-face{font-family:montserrat;font-style:normal;font-weight:100 900;font-display:swap;src:local("Montserrat"),url(/css/fonts/Montserrat-69a5c2d.woff2)format('woff2-variations')}@font-face{font-family:montserrat;font-style:italic;font-weight:100 900;font-display:swap;src:local("Montserrat Italic"),local("Montserrat-Italic"),url(/css/fonts/Montserrat-Italic-69a5c2d.woff2)format('woff2-variations')}html{font-size:80%;font-weight:400;font-family:montserrat,arial,sans-serif;scroll-behavior:smooth;scrollbar-gutter:stable}html{text-size-adjust:none}*,*::before,*::after{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;-ms-box-sizing:border-box;-o-box-sizing:border-box;box-sizing:border-box}body{line-height:1.5;-webkit-font-smoothing:antialiased}input,button,textarea,select{font:inherit}p,h1,h2,h3,h4,h5,h6{overflow-wrap:break-word}#root,#__next{isolation:isolate}body{font-size:1.6rem;background-color:#282828;color:#fbf1c7}code,pre{background-color:#1d2021}header{border-bottom:.2rem solid #98971a}nav a{font-weight:700;text-decoration:none}body img{max-width:100%;max-height:100%;display:block;margin:auto;height:auto;width:auto}body figcaption{text-align:center}footer{margin-top:3rem;padding:1.2rem 0;border-top:.2rem solid #98971a;font-size:1.2rem;color:#fbf1c7}h1{font-size:2.4rem}h2{font-size:2rem}h3{font-size:1.8rem}h4{font-size:1.6rem}.title{margin-bottom:0}article .publish-date{margin:0 0 2rem 1rem;font-size:1.4rem;color:#fbf1c7}article .last-modified-date{font-size:1rem}.logo a{font-weight:700;color:#fbf1c7;text-decoration:none}blockquote{margin:1rem 0;padding:.5rem;border-radius:.5rem .5rem .5rem .5rem;border-left:.3rem solid #98971a;background-color:#1d2021;color:#fbf1c7}html{scrollbar-width:thick;scrollbar-color:#928374 #282828}pre{scrollbar-width:thin;scrollbar-color:#928374 #282828}nav.toc{float:left;clear:left;font-size:2rem;margin-left:-28%;width:20rem;word-wrap:break-word;padding:1rem;vertical-align:baseline;position:-webkit-sticky;position:sticky;top:5vh}nav.toc a{font-size:1.4rem}nav.toc ::marker{margin:0 -1rem 0 0}nav.toc li{margin:0;padding:0;line-height:1.2}nav.toc .toc-header{font-weight:700}nav.toc ul li{list-style-position:outside}nav.toc ul{margin-top:0;margin-bottom:0}pre,code{width:100%;font-family:fira code,consolas,monospace}div.highlight.inline{display:inline}pre{white-space:pre;overflow:auto;margin:1rem 0;background-color:#1d2021;padding:1rem;border-radius:.5rem .5rem .5rem .5rem}code{word-break:break-word;padding:0 .4rem;border-radius:.3rem .3rem .3rem .3rem}html a:link{color:#689d6a;background-color:initial;text-decoration:underline}html a:visited{color:#689d6a;background-color:initial;text-decoration:underline}html a:hover{color:#8ec07c;background-color:initial;text-decoration:underline}html a:active{color:#8ec07c;background-color:initial;text-decoration:none}nav.header a:link{color:#689d6a;background-color:initial;text-decoration:none}nav.header a:visited{color:#689d6a;background-color:initial;text-decoration:none}nav.header a:hover{color:#8ec07c;background-color:initial;text-decoration:none}nav.header a:active{color:#8ec07c;background-color:initial;text-decoration:underline}nav.toc a:link{color:#689d6a;background-color:initial;text-decoration:none}nav.toc a:visited{color:#689d6a;background-color:initial;text-decoration:none}nav.toc a:hover{color:#8ec07c;background-color:initial;text-decoration:none}nav.toc a:active{color:#8ec07c;background-color:initial;text-decoration:underline}.sidenote,marginnote{width:20rem;clear:right;font-size:1.1rem;line-height:1.3;vertical-align:baseline}body{counter-set:sidenote-counter}.sidenote-number{counter-increment:sidenote-counter}.sidenote:before{content:counter(sidenote-counter)" ";position:relative;vertical-align:baseline;font-weight:700;font-size:1rem;top:-.5rem;font-size:.9em}.sidenote-number:after{content:counter(sidenote-counter);position:relative;vertical-align:baseline;font-weight:700;font-size:1rem;top:-.5rem;left:.1rem}blockquote .sidenote,blockquote .marginnote{margin-right:82%;min-width:59%;text-align:left}.sidenote>code{font-size:1rem}label.sidenote-number{display:inline-block;max-height:2rem}label.margin-toggle:not(.sidenote-number){display:none}input.margin-toggle{display:none}.post-list{margin-top:1rem}.post-list-item{margin-bottom:2rem}.post-list-item p{width:100%;margin:0}.post-description{padding-top:.5rem}.post-header-title{text-align:left}.post-header-date{text-align:right}@media all and (max-width:1439px){nav.toc{display:none}}@media all and (max-width:1439px){.sidenote,.marginnote{float:right;text-align:left;margin:1rem 0;padding-left:5%}}@media all and (min-width:1440px){.sidenote,.marginnote{float:right;margin-right:-30%;margin-top:.3rem;margin-bottom:0;position:relative}}@media all and (max-width:639px){body{width:100%;margin:0;padding:0 5%}header{margin:1rem 0}nav.header{margin:.5rem auto;text-align:center}footer{text-align:center}nav.header a{font-size:1.4rem;line-height:1.6}.logo{font-size:1.8rem}nav.header a{margin:0 .6rem}}@media all and (min-width:640px){body{width:70rem;margin:0 auto;padding:0}header{margin:0 0 3rem;padding:.6rem 0 .2rem}nav.header{display:flex;align-items:flex-end;justify-content:space-between;margin:0;text-align:right}nav.header a{font-size:1.8rem;margin:0 0 0 .6rem;display:inline}.navigation{justify-content:flex-end}footer{text-align:right}.logo{margin:0;text-align:left;font-size:2.4rem}}@media all and (max-width:1439px){.post-header{display:block}}@media all and (min-width:1440px){.post-header{display:flex}.post-header-title{padding-left:1rem}.post-description{padding-left:3rem;padding-top:.5rem}}pre{line-height:125%}td.linenos .normal{color:#3c4354;background-color:initial;padding-left:5px;padding-right:5px}span.linenos{color:#3c4354;background-color:initial;padding-left:5px;padding-right:5px}td.linenos .special{color:#3c4354;background-color:#ffffc0;padding-left:5px;padding-right:5px}span.linenos.special{color:#3c4354;background-color:#ffffc0;padding-left:5px;padding-right:5px}.hll{background-color:#6e7681}.c{color:#7e8aa1}.err{color:#f88f7f}.esc{color:#d4d2c8}.g{color:#d4d2c8}.k{color:#ffad66}.l{color:#d5ff80}.n{color:#d4d2c8}.o{color:#ffad66}.x{color:#d4d2c8}.p{color:#d4d2c8}.ch{color:#f88f7f;font-style:italic}.cm{color:#7e8aa1}.cp{color:#ffad66;font-weight:700}.cpf{color:#7e8aa1}.c1{color:#7e8aa1}.cs{color:#7e8aa1;font-style:italic}.gd{color:#f88f7f;background-color:#3d1e20}.ge{color:#d4d2c8;font-style:italic}.ges{color:#d4d2c8}.gr{color:#f88f7f}.gh{color:#d4d2c8}.gi{color:#6ad4af;background-color:#19362c}.go{color:#7e8aa1}.gp{color:#d4d2c8}.gs{color:#d4d2c8;font-weight:700}.gu{color:#d4d2c8}.gt{color:#f88f7f}.kc{color:#ffad66}.kd{color:#ffad66}.kn{color:#ffad66}.kp{color:#ffad66}.kr{color:#ffad66}.kt{color:#73d0ff}.ld{color:#d5ff80}.m{color:#dfbfff}.s{color:#d5ff80}.na{color:#ffd173}.nb{color:#ffd173}.nc{color:#73d0ff}.no{color:#ffd173}.nd{color:#7e8aa1;font-weight:700;font-style:italic}.ni{color:#95e6cb}.ne{color:#73d0ff}.nf{color:#ffd173}.nl{color:#d4d2c8}.nn{color:#d4d2c8}.nx{color:#d4d2c8}.py{color:#ffd173}.nt{color:#5ccfe6}.nv{color:#d4d2c8}.ow{color:#ffad66}.pm{color:#d4d2c8}.w{color:#d4d2c8}.mb{color:#dfbfff}.mf{color:#dfbfff}.mh{color:#dfbfff}.mi{color:#dfbfff}.mo{color:#dfbfff}.sa{color:#f29e74}.sb{color:#d5ff80}.sc{color:#d5ff80}.dl{color:#d5ff80}.sd{color:#7e8aa1}.s2{color:#d5ff80}.se{color:#95e6cb}.sh{color:#d5ff80}.si{color:#95e6cb}.sx{color:#95e6cb}.sr{color:#95e6cb}.s1{color:#d5ff80}.ss{color:#dfbfff}.bp{color:#5ccfe6}.fm{color:#ffd173}.vc{color:#d4d2c8}.vg{color:#d4d2c8}.vi{color:#d4d2c8}.vm{color:#d4d2c8}.il{color:#dfbfff}</style><link rel=preload href=../css/fonts/Montserrat-69a5c2d.woff2 crossorigin=anonymous as=font type=font/woff2><link rel=stylesheet href=../css/katex.css media=print onload='this.media="all"'><noscript><link rel=stylesheet href=../css/katex.css></noscript><link rel="shortcut icon" href=favicon.ico type=image/x-icon><link rel="shortcut icon" href=../images/favicons/favicon32.png><link rel=apple-touch-icon-precomposed sizes=144x144 href=../images/favicons/favicon144.png><link rel=apple-touch-icon-precomposed sizes=114x114 href=../images/favicons/favicon114.png><link rel=apple-touch-icon-precomposed sizes=72x72 href=../images/favicons/favicon72.png><link rel=apple-touch-icon-precomposed sizes=57x57 href=../images/favicons/favicon57.png><header><nav class=header><a class=logo href=../>(Non-)Functional Ramblings</a><div class=navigation><a href=../about.html>About</a>
<a href=../static/resume.pdf>Resume</a>
<a href=../archive.html>Archive</a>
<a href=../atom.xml>Feed</a></div></nav></header><main role=main><h1 class=title>Functional programmers enter a diner…</h1><article><section class=publish-date><em>Posted on October 20, 2025</em></section><section><blockquote>A fun, I think, thought experiment to avoid concurrency deadlocks by enforcing a fixed, predefined order for acquiring static sets of MVars.</blockquote></section><section><h2 id=whats-on-the-menu>What’s on the menu?</h2><p></p>If you have an application that carries quite some state that needs to be
accessed by multiple threads concurrently, you have a choice in how to expose
this state to those threads. One option is to put each state component in its
own <code>MVar</code>. Interfacing with these <code>MVar</code>’s is straightforward, but exposes your
application to deadlocks, if for example, multiple threads want to acquire
resources that the other one has.<p></p>One way to avoid this, is to ensure that resources are always (preemptively)
acquired in a fixed order for any computation. The thought experiment is then,
is it possible to write an interface for which this is possible for any subset
of static locks in an application? Against Betteridge’s law, I think the
following is quite nifty, if verbose.<p></p>This can be seen as a continuance to, at this point, my series of blog posts on
<a href=../posts/roly-oly-polyvariadic-boogaloo.html>polyvariadic functions</a>, as the
interface I’d ideally want would just work for any number of locks.<div class=highlight><pre tabindex=0><span></span><span class=c1>-- So an interface akin to the following:</span>
<span class=nf>withLocks</span><span class=w> </span><span class=n>locks</span><span class=w> </span><span class=o>$</span><span class=w> </span><span class=nf>\</span><span class=n>b</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=o>...</span>
<span class=nf>withLocks</span><span class=w> </span><span class=n>locks</span><span class=w> </span><span class=o>$</span><span class=w> </span><span class=nf>\</span><span class=n>c</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=o>...</span>
</pre></div><p></p>I’ll be working with a running example. Say there’s some state that’s split up
into three locks. And because I’m allowing myself the restriction of working
with a static set of locks, I’ll also add some singletons that’ll be useful
later. <label for=sn-0 class="margin-toggle sidenote-number"></label><input type=checkbox id=sn-0 class=margin-toggle><div class=sidenote>I’ll also need quite a few helpers in converting these lock
singletons to and from values that can actually be sorted. See this as just
boilerplate, and try not to look too much at it.<div class=highlight><pre tabindex=0><span></span><span class=kr>data</span><span class=w> </span><span class=kt>AllLocks</span>
<span class=w>  </span><span class=ow>=</span><span class=w> </span><span class=kt>ALock_</span>
<span class=w>  </span><span class=o>|</span><span class=w> </span><span class=kt>BLock_</span>
<span class=w>  </span><span class=o>|</span><span class=w> </span><span class=kt>CLock_</span>
<span class=w>  </span><span class=kr>deriving</span><span class=w> </span><span class=p>(</span><span class=kt>Eq</span><span class=p>,</span><span class=w> </span><span class=kt>Ord</span><span class=p>)</span>

<span class=kr>data</span><span class=w> </span><span class=kt>LockRequest</span><span class=w> </span><span class=n>l</span><span class=w> </span><span class=kr>where</span>
<span class=w>  </span><span class=kt>ALockRequest</span><span class=w> </span><span class=ow>::</span><span class=w> </span><span class=kt>LockRequest</span><span class=w> </span><span class=kt>ALock</span>
<span class=w>  </span><span class=kt>BLockRequest</span><span class=w> </span><span class=ow>::</span><span class=w> </span><span class=kt>LockRequest</span><span class=w> </span><span class=kt>BLock</span>
<span class=w>  </span><span class=kt>CLockRequest</span><span class=w> </span><span class=ow>::</span><span class=w> </span><span class=kt>LockRequest</span><span class=w> </span><span class=kt>CLock</span>

<span class=nf>lockToValue</span><span class=w> </span><span class=ow>::</span><span class=w> </span><span class=kt>Some</span><span class=w> </span><span class=kt>LockRequest</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>AllLocks</span>
<span class=nf>lockToValue</span><span class=w> </span><span class=n>s</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=kr>case</span><span class=w> </span><span class=n>s</span><span class=w> </span><span class=kr>of</span>
<span class=w>  </span><span class=kt>Some</span><span class=w> </span><span class=kt>ALockRequest</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>ALock_</span>
<span class=w>  </span><span class=kt>Some</span><span class=w> </span><span class=kt>BLockRequest</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>BLock_</span>
<span class=w>  </span><span class=kt>Some</span><span class=w> </span><span class=kt>CLockRequest</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>CLock_</span>

<span class=nf>valueToLock</span><span class=w> </span><span class=ow>::</span><span class=w> </span><span class=kt>AllLocks</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>Some</span><span class=w> </span><span class=kt>LockRequest</span>
<span class=nf>valueToLock</span><span class=w> </span><span class=n>s</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=kr>case</span><span class=w> </span><span class=n>s</span><span class=w> </span><span class=kr>of</span>
<span class=w>  </span><span class=kt>ALock_</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>Some</span><span class=w> </span><span class=kt>ALockRequest</span>
<span class=w>  </span><span class=kt>BLock_</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>Some</span><span class=w> </span><span class=kt>BLockRequest</span>
<span class=w>  </span><span class=kt>CLock_</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>Some</span><span class=w> </span><span class=kt>CLockRequest</span>

<span class=kr>data</span><span class=w> </span><span class=kt>ContentsOf</span><span class=w> </span><span class=n>l</span><span class=w> </span><span class=kr>where</span>
<span class=w>  </span><span class=kt>LockOfA</span><span class=w> </span><span class=ow>::</span><span class=w> </span><span class=kt>Int</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>ContentsOf</span><span class=w> </span><span class=kt>ALock</span>
<span class=w>  </span><span class=kt>LockOfB</span><span class=w> </span><span class=ow>::</span><span class=w> </span><span class=kt>String</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>ContentsOf</span><span class=w> </span><span class=kt>BLock</span>
<span class=w>  </span><span class=kt>LockOfC</span><span class=w> </span><span class=ow>::</span><span class=w> </span><span class=nb>()</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>ContentsOf</span><span class=w> </span><span class=kt>CLock</span>
</pre></div></div><div class=highlight><pre tabindex=0><span></span><span class=kr>data</span><span class=w> </span><span class=kt>Locks</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=kt>Locks</span>
<span class=w>  </span><span class=p>{</span><span class=w> </span><span class=n>aLock</span><span class=w> </span><span class=ow>::</span><span class=w> </span><span class=kt>MVar</span><span class=w> </span><span class=kt>Int</span>
<span class=w>  </span><span class=p>,</span><span class=w> </span><span class=n>bLock</span><span class=w> </span><span class=ow>::</span><span class=w> </span><span class=kt>MVar</span><span class=w> </span><span class=kt>String</span>
<span class=w>  </span><span class=p>,</span><span class=w> </span><span class=n>cLock</span><span class=w> </span><span class=ow>::</span><span class=w> </span><span class=kt>MVar</span><span class=w> </span><span class=nb>()</span>
<span class=w>  </span><span class=p>}</span>

<span class=c1>-- Each one represents its respective lock in the state.</span>
<span class=kr>data</span><span class=w> </span><span class=kt>ALock</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=kt>ALock</span>
<span class=kr>data</span><span class=w> </span><span class=kt>BLock</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=kt>BLock</span>
<span class=kr>data</span><span class=w> </span><span class=kt>CLock</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=kt>CLock</span>
</pre></div><h2 id=chefs-choice>Chef’s choice</h2><p></p>The hardest part about the above interface is that the polyvariadic function
we’re building is a continuation. We need to acquire all locks in the right
order, and provide the underlying resources to the supplied function. Peeling
this into concrete steps, gives the following.<ol type=1><li>Identify all locks that are wanted by the underlying function<li>Sort these locks according to a fixed ordering<li>Acquire the locks<li>Provide the lock contents to the underlying function</ol><p></p>These four steps can’t be done incrementally on each lock. The second step is
the only real valuable functionality this interface is providing, and can only
be done once the set of requested locks is fully known. One way to do this
is to first accumulate all lock requests, and only then give the concrete
continuation.<p></p>But what do we actually accumulate? A first attempt might be the following where
we build up the continuation like a list. For each lock we add, we ensure that
the continuation grows with the contents of that lock accordingly. The base case
should look pretty standard as the identity function. When we <code>cons</code> a lock
request, we’d also want supply how we provide the contents of the lock.<div class=highlight><pre tabindex=0><span></span><span class=kr>data</span><span class=w> </span><span class=kt>LockProvider</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=kr>where</span>
<span class=w>  </span><span class=kt>LockProviderCons</span>
<span class=w>    </span><span class=ow>::</span><span class=w> </span><span class=o>...</span>
<span class=w>    </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>LockProvider</span><span class=w> </span><span class=p>(</span><span class=n>c</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=n>r</span><span class=p>)</span>
<span class=w>    </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>LockProvider</span><span class=w> </span><span class=p>((</span><span class=kt>ContentsOf</span><span class=w> </span><span class=n>l</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=n>c</span><span class=p>)</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=n>r</span><span class=p>)</span>
<span class=w>  </span><span class=kt>LockProviderNil</span>
<span class=w>    </span><span class=ow>::</span><span class=w> </span><span class=kt>LockProvider</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=n>r</span><span class=p>)</span>
</pre></div><p></p>The above captures the signature we want to generate, but doesn’t yet give us
the tools to generate it. We still need <code>ContentsOf</code>, or more importantly, a way
to provide it.<p></p>A few ideas come to mind. If we were to take the idea of a lock
naively, we could look at the type signature of functions like <code>readMVar</code> or
<code>takeMVar</code>, giving <code>IO (ContentsOf l)</code> for some lock <code>l</code>. That doesn’t ensure
we always unlock the <code>MVar</code> though. For that <code>withMVar</code> would be more apt, which
would correspond to the type signature of <code>forall r. (ContentsOf l -> IO r) -> IO r</code>, which is isomorphic to <code>ContT r IO (ContentsOf l)</code>.<p></p>Note that both <code>takeMVar/readMVar</code> and <code>withMVar</code> are valid. Key observation
here is that if we choose to follow the type signature of either of these
functions, we’re pigeonholing our <code>LockProvider</code> mini-DSL to a specific
behavior. For that reason, and because I’ll actually use both interpretations,
I’ll choose to keep the type generic.<div class=highlight><pre tabindex=0><span></span><span class=kr>data</span><span class=w> </span><span class=kt>LockProvider</span><span class=w> </span><span class=n>f</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=kr>where</span>
<span class=w>  </span><span class=kt>LockProviderCons</span>
<span class=w>    </span><span class=ow>::</span><span class=w> </span><span class=n>forall</span><span class=w> </span><span class=n>l</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=n>r</span>
<span class=w>     </span><span class=o>.</span><span class=w> </span><span class=kt>LockRequest</span><span class=w> </span><span class=n>l</span>
<span class=w>    </span><span class=ow>-&gt;</span><span class=w> </span><span class=p>(</span><span class=n>f</span><span class=w> </span><span class=p>(</span><span class=kt>ContentsOf</span><span class=w> </span><span class=n>l</span><span class=p>))</span>
<span class=w>    </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>LockProvider</span><span class=w> </span><span class=p>(</span><span class=n>c</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=n>r</span><span class=p>)</span>
<span class=w>    </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>LockProvider</span><span class=w> </span><span class=p>((</span><span class=kt>ContentsOf</span><span class=w> </span><span class=n>l</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=n>c</span><span class=p>)</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=n>r</span><span class=p>)</span>
<span class=w>  </span><span class=kt>LockProviderNil</span>
<span class=w>    </span><span class=ow>::</span><span class=w> </span><span class=kt>LockProvider</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=n>r</span><span class=p>)</span>
</pre></div><p></p>Next is how to convert this datatype into an appropriate continuation. Because
we both gather and sort, we’ll need to keep the order of the lock requests at
least fixed somehow to be able to create a function that satisfies the built-up
signature.<h2 id=continuationing-polyvariadicity>Continuationing polyvariadicity</h2><p></p>There’s a peculiar disconnect here, we gather and provide the lock
requests and contents respectively in a certain ordering, and we have to acquire
those exact locks in a different one. To not make my life anymore harder than
it needs to be, I’ll enforce the second ordering using evaluation in <code>IO</code> using
<code>IORef</code>’s. Being able to manipulate the evaluation order is what the type
variable <code>f</code> is intended for.<div class=highlight><pre tabindex=0><span></span><span class=c1>-- It's not exactly IO, interacting with the locks safely occurs</span>
<span class=c1>-- within continuations. So we need `ContT IO`.</span>
<span class=kr>newtype</span><span class=w> </span><span class=kt>Acquire</span><span class=w> </span><span class=n>l</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=kt>Acquire</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>acquire</span><span class=w> </span><span class=ow>::</span><span class=w> </span><span class=n>forall</span><span class=w> </span><span class=n>r</span><span class=o>.</span><span class=w> </span><span class=kt>ContT</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=kt>IO</span><span class=w> </span><span class=n>l</span><span class=w> </span><span class=p>}</span>
<span class=w>  </span><span class=kr>deriving</span><span class=w> </span><span class=kt>Functor</span>

<span class=nf>getA</span><span class=w> </span><span class=ow>::</span><span class=w> </span><span class=kt>Locks</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>Acquire</span><span class=w> </span><span class=p>(</span><span class=kt>ContentsOf</span><span class=w> </span><span class=kt>ALock</span><span class=p>)</span>
<span class=nf>getA</span><span class=w> </span><span class=n>locks</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=kt>Acquire</span><span class=w> </span><span class=o>$</span><span class=w> </span><span class=kt>ContT</span><span class=w> </span><span class=o>$</span><span class=w> </span><span class=nf>\</span><span class=n>action'</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kr>do</span>
<span class=w>  </span><span class=n>withMVar</span><span class=w> </span><span class=p>(</span><span class=n>aLock</span><span class=w> </span><span class=n>locks</span><span class=p>)</span><span class=w> </span><span class=o>$</span>
<span class=w>    </span><span class=nf>\</span><span class=n>contents</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=n>action'</span><span class=w> </span><span class=p>(</span><span class=kt>LockOfA</span><span class=w> </span><span class=n>contents</span><span class=p>)</span>
</pre></div><p></p>Using what is practically a minimal DSL for specifying how to acquire locks, I
can now play around with this and reorder the acquisitions.<label for=sn-1 class="margin-toggle sidenote-number"></label><input type=checkbox id=sn-1 class=margin-toggle><div class=sidenote>Because the DSL is functor-ish, and I’m reusing it in multiple places, I’ll create a few minimal helpers.<div class=highlight><pre tabindex=0><span></span><span class=kr>type</span><span class=w> </span><span class=n>f</span><span class=w> </span><span class=err>∘</span><span class=w> </span><span class=n>g</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=kt>Compose</span><span class=w> </span><span class=n>f</span><span class=w> </span><span class=n>g</span>
<span class=kr>infixr</span><span class=w> </span><span class=mi>8</span><span class=w> </span><span class=err>∘</span>
</pre></div></div><div class=highlight><pre tabindex=0><span></span><span class=kr>data</span><span class=w> </span><span class=kt>Defer</span><span class=w> </span><span class=n>l</span>
<span class=w>  </span><span class=ow>=</span><span class=w> </span><span class=kt>Defer</span><span class=w> </span><span class=p>{</span><span class=n>unDefer</span><span class=w> </span><span class=ow>::</span><span class=w> </span><span class=kt>Acquire</span><span class=w> </span><span class=n>l</span><span class=p>}</span>
<span class=w>  </span><span class=o>|</span><span class=w> </span><span class=kt>Evaluated</span><span class=w> </span><span class=n>l</span>

<span class=c1>-- Turn the lock acquisition requests into stateful slots we can use</span>
<span class=c1>-- to acquire at a later point in time.</span>
<span class=nf>prepareLockProvider</span><span class=w> </span><span class=ow>::</span>
<span class=w>  </span><span class=kt>LockProvider</span><span class=w> </span><span class=kt>Acquire</span><span class=w> </span><span class=n>continuation</span><span class=w> </span><span class=ow>-&gt;</span>
<span class=w>  </span><span class=kt>IO</span><span class=w> </span><span class=p>(</span><span class=kt>LockProvider</span><span class=w> </span><span class=p>(</span><span class=kt>IORef</span><span class=w> </span><span class=err>∘</span><span class=w> </span><span class=kt>Defer</span><span class=p>)</span><span class=w> </span><span class=n>continuation</span><span class=p>)</span>
<span class=nf>prepareLockProvider</span><span class=w> </span><span class=n>lp</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=kr>do</span>
<span class=w>  </span><span class=kr>case</span><span class=w> </span><span class=n>lp</span><span class=w> </span><span class=kr>of</span>
<span class=w>    </span><span class=kt>LockProviderCons</span><span class=w> </span><span class=n>lockRequest</span><span class=w> </span><span class=n>action</span><span class=w> </span><span class=n>continuation</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kr>do</span>
<span class=w>      </span><span class=n>ref</span><span class=w> </span><span class=ow>&lt;-</span><span class=w> </span><span class=kt>Compose</span><span class=w> </span><span class=o>&lt;$&gt;</span><span class=w> </span><span class=n>newIORef</span><span class=w> </span><span class=p>(</span><span class=kt>Defer</span><span class=w> </span><span class=n>action</span><span class=p>)</span>
<span class=w>      </span><span class=n>rest</span><span class=w> </span><span class=ow>&lt;-</span><span class=w> </span><span class=n>prepareLockProvider</span><span class=w> </span><span class=n>continuation</span>
<span class=w>      </span><span class=n>pure</span><span class=w> </span><span class=o>$</span><span class=w> </span><span class=kt>LockProviderCons</span><span class=w> </span><span class=n>lockRequest</span><span class=w> </span><span class=n>ref</span><span class=w> </span><span class=n>rest</span>
<span class=w>    </span><span class=kt>LockProviderNil</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=n>pure</span><span class=w> </span><span class=kt>LockProviderNil</span>
</pre></div><p></p>The next task is to convert the lock requests along with their deferred
acquisitions into something we can sort. The lock requests are already sortable,
so tupling them up should be enough. I’ll need an existential wrapper though
to elide the exact contents of each lock, which we don’t care about yet at this
point.<label for=sn-2 class="margin-toggle sidenote-number"></label><input type=checkbox id=sn-2 class=margin-toggle><div class=sidenote><a href=https://hackage.haskell.org/package/some><code>Some</code></a> exists, so I could have made this an alias to <code>Some ∘ Pair f g</code>, but this was already quite the mess.<div class=highlight><pre tabindex=0><span></span><span class=kr>data</span><span class=w> </span><span class=kt>BiSome</span><span class=w> </span><span class=n>f</span><span class=w> </span><span class=n>g</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=n>forall</span><span class=w> </span><span class=n>l</span><span class=o>.</span><span class=w> </span><span class=kt>BiSome</span>
<span class=w>  </span><span class=p>{</span><span class=w> </span><span class=n>getBiSome</span><span class=w> </span><span class=ow>::</span><span class=w> </span><span class=p>(</span><span class=n>f</span><span class=w> </span><span class=n>l</span><span class=p>,</span><span class=w> </span><span class=n>g</span><span class=w> </span><span class=n>l</span><span class=p>)</span>
<span class=w>  </span><span class=p>}</span>
</pre></div></div><div class=highlight><pre tabindex=0><span></span><span class=c1>-- Pretty straightforward, recursively iterate over the DSL and</span>
<span class=c1>-- accumulate every lock request and deferred acquisition into a list.</span>
<span class=nf>gatherLocks</span><span class=w> </span><span class=ow>::</span>
<span class=w>  </span><span class=kt>LockProvider</span><span class=w> </span><span class=p>(</span><span class=kt>IORef</span><span class=w> </span><span class=err>∘</span><span class=w> </span><span class=kt>Defer</span><span class=p>)</span><span class=w> </span><span class=n>continuation</span><span class=w> </span><span class=ow>-&gt;</span>
<span class=w>  </span><span class=kt>IO</span><span class=w> </span><span class=p>[</span><span class=kt>BiSome</span><span class=w> </span><span class=kt>LockRequest</span><span class=w> </span><span class=p>(</span><span class=kt>IORef</span><span class=w> </span><span class=err>∘</span><span class=w> </span><span class=kt>Defer</span><span class=w> </span><span class=err>∘</span><span class=w> </span><span class=kt>ContentsOf</span><span class=p>)]</span>
<span class=nf>gatherLocks</span><span class=w> </span><span class=n>lp</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=kr>case</span><span class=w> </span><span class=n>lp</span><span class=w> </span><span class=kr>of</span>
<span class=w>  </span><span class=kt>LockProviderCons</span><span class=w> </span><span class=n>lockRequest</span><span class=w> </span><span class=n>action</span><span class=w> </span><span class=n>continuation</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kr>do</span>
<span class=w>    </span><span class=kr>let</span><span class=w> </span><span class=n>action'</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=n>action</span>
<span class=w>    </span><span class=n>rest</span><span class=w> </span><span class=ow>&lt;-</span><span class=w> </span><span class=n>gatherLocks</span><span class=w> </span><span class=n>continuation</span>
<span class=w>    </span><span class=n>pure</span><span class=w> </span><span class=o>$</span><span class=w> </span><span class=kt>BiSome</span><span class=w> </span><span class=p>(</span><span class=n>lockRequest</span><span class=p>,</span><span class=w> </span><span class=n>coerce</span><span class=w> </span><span class=n>action'</span><span class=p>)</span><span class=w> </span><span class=kt>:</span><span class=w> </span><span class=n>rest</span>
<span class=w>  </span><span class=kt>LockProviderNil</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=n>pure</span><span class=w> </span><span class=kt>[]</span>
</pre></div><p></p>Once everything’s in a proper list, we can sort using the <code>LockRequest</code> in
the existential wrapper. And finally, we can acquire every locked resource and
subsequently execute the continuation.<div class=highlight><pre tabindex=0><span></span><span class=c1>-- With the accumulated requests, first sort on the request using the</span>
<span class=c1>-- fixed 'Ord' instance and execute once everything has been acquired.</span>
<span class=nf>requestLocksSorted</span>
<span class=w>  </span><span class=ow>::</span><span class=w> </span><span class=n>forall</span><span class=w> </span><span class=n>r</span>
<span class=w>   </span><span class=o>.</span><span class=w> </span><span class=p>[</span><span class=kt>BiSome</span><span class=w> </span><span class=kt>LockRequest</span><span class=w> </span><span class=p>(</span><span class=kt>IORef</span><span class=w> </span><span class=err>∘</span><span class=w> </span><span class=kt>Defer</span><span class=w> </span><span class=err>∘</span><span class=w> </span><span class=kt>ContentsOf</span><span class=p>)]</span>
<span class=w>  </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>IO</span><span class=w> </span><span class=n>r</span>
<span class=w>  </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>IO</span><span class=w> </span><span class=n>r</span>
<span class=nf>requestLocksSorted</span><span class=w> </span><span class=n>ls</span><span class=w> </span><span class=n>action</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=kr>do</span>
<span class=w>  </span><span class=kr>let</span><span class=w> </span><span class=n>eval</span>
<span class=w>        </span><span class=ow>::</span><span class=w> </span><span class=p>[</span><span class=kt>BiSome</span><span class=w> </span><span class=kt>LockRequest</span><span class=w> </span><span class=p>(</span><span class=kt>IORef</span><span class=w> </span><span class=err>∘</span><span class=w> </span><span class=kt>Defer</span><span class=w> </span><span class=err>∘</span><span class=w> </span><span class=kt>ContentsOf</span><span class=p>)]</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>IO</span><span class=w> </span><span class=n>r</span>
<span class=w>      </span><span class=n>eval</span><span class=w> </span><span class=kt>[]</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=n>action</span>
<span class=w>      </span><span class=n>eval</span><span class=w> </span><span class=p>((</span><span class=kt>BiSome</span><span class=w> </span><span class=p>(</span><span class=kr>_</span><span class=p>,</span><span class=w> </span><span class=kt>Compose</span><span class=w> </span><span class=n>ioRef</span><span class=p>))</span><span class=w> </span><span class=kt>:</span><span class=w> </span><span class=n>rest</span><span class=p>)</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=kr>do</span>
<span class=w>        </span><span class=n>ref'</span><span class=w> </span><span class=ow>&lt;-</span><span class=w> </span><span class=n>getCompose</span><span class=w> </span><span class=o>&lt;$&gt;</span><span class=w> </span><span class=n>readIORef</span><span class=w> </span><span class=n>ioRef</span>
<span class=w>        </span><span class=kr>case</span><span class=w> </span><span class=n>ref'</span><span class=w> </span><span class=kr>of</span>
<span class=w>          </span><span class=kt>Defer</span><span class=w> </span><span class=p>(</span><span class=kt>Acquire</span><span class=w> </span><span class=n>l</span><span class=p>)</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kr>do</span>
<span class=w>            </span><span class=n>runContT</span><span class=w> </span><span class=n>l</span><span class=w> </span><span class=o>$</span><span class=w> </span><span class=nf>\</span><span class=n>l'</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kr>do</span>
<span class=w>              </span><span class=n>writeIORef</span><span class=w> </span><span class=n>ioRef</span><span class=w> </span><span class=p>(</span><span class=kt>Compose</span><span class=w> </span><span class=p>(</span><span class=kt>Evaluated</span><span class=w> </span><span class=n>l'</span><span class=p>))</span>
<span class=w>              </span><span class=n>eval</span><span class=w> </span><span class=n>rest</span>
<span class=w>          </span><span class=kt>Evaluated</span><span class=w> </span><span class=kr>_</span><span class=w> </span><span class=ow>-&gt;</span>
<span class=w>            </span><span class=n>eval</span><span class=w> </span><span class=n>rest</span>
<span class=w>      </span><span class=n>lockValue</span><span class=w> </span><span class=p>(</span><span class=kt>BiSome</span><span class=w> </span><span class=p>(</span><span class=n>lr</span><span class=p>,</span><span class=w> </span><span class=n>_ioRef</span><span class=p>))</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=n>lockToValue</span><span class=w> </span><span class=p>(</span><span class=kt>Some</span><span class=w> </span><span class=n>lr</span><span class=p>)</span>
<span class=w>  </span><span class=n>eval</span><span class=w> </span><span class=p>(</span><span class=n>sortOn</span><span class=w> </span><span class=n>lockValue</span><span class=w> </span><span class=n>ls</span><span class=p>)</span>

<span class=c1>-- The action we execute once everything has been acquired consists of</span>
<span class=c1>-- reading every lock's contents and passing it to the continuation.</span>
<span class=nf>giveLockContents</span>
<span class=w>  </span><span class=ow>::</span><span class=w> </span><span class=kt>LockProvider</span><span class=w> </span><span class=p>(</span><span class=kt>IORef</span><span class=w> </span><span class=err>∘</span><span class=w> </span><span class=kt>Defer</span><span class=p>)</span><span class=w> </span><span class=n>continuation</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>IO</span><span class=w> </span><span class=n>continuation</span>
<span class=nf>giveLockContents</span><span class=w> </span><span class=n>lp</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=kr>case</span><span class=w> </span><span class=n>lp</span><span class=w> </span><span class=kr>of</span>
<span class=w>  </span><span class=kt>LockProviderCons</span><span class=w> </span><span class=kr>_</span><span class=w> </span><span class=n>ioRef</span><span class=w> </span><span class=n>continuation</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kr>do</span>
<span class=w>    </span><span class=n>ref</span><span class=w> </span><span class=ow>&lt;-</span><span class=w> </span><span class=n>readIORef</span><span class=w> </span><span class=p>(</span><span class=n>getCompose</span><span class=w> </span><span class=n>ioRef</span><span class=p>)</span>
<span class=w>    </span><span class=kr>case</span><span class=w> </span><span class=n>ref</span><span class=w> </span><span class=kr>of</span>
<span class=w>      </span><span class=kt>Evaluated</span><span class=w> </span><span class=n>l</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kr>do</span>
<span class=w>        </span><span class=n>continue</span><span class=w> </span><span class=ow>&lt;-</span><span class=w> </span><span class=n>giveLockContents</span><span class=w> </span><span class=n>continuation</span>
<span class=w>        </span><span class=n>pure</span><span class=w> </span><span class=o>$</span><span class=w> </span><span class=nf>\</span><span class=n>f</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=n>continue</span><span class=w> </span><span class=p>(</span><span class=n>f</span><span class=w> </span><span class=n>l</span><span class=p>)</span>
<span class=w>      </span><span class=kr>_</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=ne>error</span><span class=w> </span><span class=s>&quot;not evaluated yet&quot;</span>
<span class=w>  </span><span class=kt>LockProviderNil</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=n>pure</span><span class=w> </span><span class=n>id</span>
</pre></div><p></p>The final interface is pretty neat.<div class=highlight><pre tabindex=0><span></span><span class=nf>provideAllLocks</span>
<span class=w>  </span><span class=ow>::</span><span class=w> </span><span class=kt>LockProvider</span><span class=w> </span><span class=kt>Acquire</span><span class=w> </span><span class=n>continuation</span>
<span class=w>  </span><span class=ow>-&gt;</span><span class=w> </span><span class=p>(</span><span class=n>continuation</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>IO</span><span class=w> </span><span class=n>r</span><span class=p>)</span>
<span class=w>  </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>IO</span><span class=w> </span><span class=n>r</span>
<span class=nf>provideAllLocks</span><span class=w> </span><span class=n>lp</span><span class=w> </span><span class=n>action</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=kr>do</span>
<span class=w>  </span><span class=n>lp'</span><span class=w> </span><span class=ow>&lt;-</span><span class=w> </span><span class=n>prepareLockProvider</span><span class=w> </span><span class=n>lp</span>
<span class=w>  </span><span class=n>gathered</span><span class=w> </span><span class=ow>&lt;-</span><span class=w> </span><span class=n>gatherLocks</span><span class=w> </span><span class=n>lp'</span>
<span class=w>  </span><span class=kr>let</span><span class=w> </span><span class=n>actWithLocks</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=n>giveLockContents</span><span class=w> </span><span class=n>lp'</span><span class=w> </span><span class=o>&gt;&gt;=</span><span class=w> </span><span class=n>action</span>
<span class=w>  </span><span class=n>requestLocksSorted</span><span class=w> </span><span class=n>gathered</span><span class=w> </span><span class=n>actWithLocks</span>
</pre></div><p></p>There’s quite a few options in how to build the exact
<code>LockProvider</code> value. To stay in the polyvariadic theme, <a href=../appendix/functional-programmers-enter-a-diner-code.html>the
appendix</a> contains how
to have every lock’s contents be inferred from type class resolution. The final
example can look something like this.<div class=highlight><pre tabindex=0><span></span><span class=nf>provideLocks</span>
<span class=w>  </span><span class=ow>::</span><span class=w> </span><span class=p>(</span><span class=kt>ProvidesLock</span><span class=w> </span><span class=n>continuation</span><span class=p>)</span>
<span class=w>  </span><span class=ow>=&gt;</span><span class=w> </span><span class=kt>Locks</span>
<span class=w>  </span><span class=ow>-&gt;</span><span class=w> </span><span class=p>(</span><span class=n>continuation</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>IO</span><span class=w> </span><span class=n>r</span><span class=p>)</span>
<span class=w>  </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>IO</span><span class=w> </span><span class=n>r</span>
<span class=nf>provideLocks</span><span class=w> </span><span class=n>state</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=n>provideAllLocks</span><span class=w> </span><span class=p>(</span><span class=n>provideLock</span><span class=w> </span><span class=n>state</span><span class=p>)</span>

<span class=nf>example'</span>
<span class=w>  </span><span class=ow>::</span><span class=w> </span><span class=kt>Locks</span>
<span class=w>  </span><span class=ow>-&gt;</span><span class=w> </span><span class=p>(</span><span class=kt>ContentsOf</span><span class=w> </span><span class=kt>BLock</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>IO</span><span class=w> </span><span class=kt>Int</span><span class=p>)</span>
<span class=w>  </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>IO</span><span class=w> </span><span class=kt>Int</span>
<span class=nf>example'</span><span class=w> </span><span class=n>locks</span><span class=w> </span><span class=n>action</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=kr>do</span>
<span class=w>  </span><span class=n>provideLocks</span><span class=w> </span><span class=n>locks</span><span class=w> </span><span class=o>$</span><span class=w> </span><span class=nf>\</span><span class=n>with</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=n>with</span><span class=w> </span><span class=n>action</span>

<span class=nf>example''</span>
<span class=w>  </span><span class=ow>::</span><span class=w> </span><span class=kt>Locks</span>
<span class=w>  </span><span class=ow>-&gt;</span><span class=w> </span><span class=p>(</span><span class=kt>ContentsOf</span><span class=w> </span><span class=kt>BLock</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>ContentsOf</span><span class=w> </span><span class=kt>ALock</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>IO</span><span class=w> </span><span class=kt>Int</span><span class=p>)</span>
<span class=w>  </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>IO</span><span class=w> </span><span class=kt>Int</span>
<span class=nf>example''</span><span class=w> </span><span class=n>locks</span><span class=w> </span><span class=n>action</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=kr>do</span>
<span class=w>  </span><span class=n>provideLocks</span><span class=w> </span><span class=n>locks</span><span class=w> </span><span class=o>$</span><span class=w> </span><span class=nf>\</span><span class=n>with</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=n>with</span><span class=w> </span><span class=n>action</span>

<span class=nf>withLocks</span>
<span class=w>  </span><span class=ow>::</span><span class=w> </span><span class=p>(</span><span class=kt>ProvidesLock</span><span class=w> </span><span class=p>(</span><span class=n>f</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>IO</span><span class=w> </span><span class=n>b</span><span class=p>),</span><span class=w> </span><span class=kt>Result</span><span class=w> </span><span class=n>f</span><span class=w> </span><span class=o>~</span><span class=w> </span><span class=kt>IO</span><span class=w> </span><span class=n>b</span><span class=p>)</span>
<span class=w>  </span><span class=ow>=&gt;</span><span class=w> </span><span class=kt>Locks</span>
<span class=w>  </span><span class=ow>-&gt;</span><span class=w> </span><span class=n>f</span>
<span class=w>  </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>IO</span><span class=w> </span><span class=n>b</span>
<span class=nf>withLocks</span><span class=w> </span><span class=n>locks</span><span class=w> </span><span class=n>action</span><span class=w> </span><span class=ow>=</span>
<span class=w>  </span><span class=n>provideLocks</span><span class=w> </span><span class=n>locks</span><span class=w> </span><span class=o>$</span><span class=w> </span><span class=nf>\</span><span class=n>with</span><span class=w> </span><span class=ow>-&gt;</span>
<span class=w>    </span><span class=n>with</span><span class=w> </span><span class=n>action</span>

<span class=nf>example'''</span><span class=w> </span><span class=ow>::</span><span class=w> </span><span class=kt>Locks</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>IO</span><span class=w> </span><span class=nb>()</span>
<span class=nf>example'''</span><span class=w> </span><span class=n>locks</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=kr>do</span>
<span class=w>  </span><span class=n>withLocks</span><span class=w> </span><span class=o>@</span><span class=p>(</span><span class=kt>ContentsOf</span><span class=w> </span><span class=kt>BLock</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>ContentsOf</span><span class=w> </span><span class=kt>ALock</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=kt>IO</span><span class=w> </span><span class=nb>()</span><span class=p>)</span><span class=w> </span><span class=n>locks</span><span class=w> </span><span class=o>$</span>
<span class=w>    </span><span class=nf>\</span><span class=n>b</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=ow>-&gt;</span><span class=w> </span><span class=n>print</span><span class=w> </span><span class=s>&quot;contents&quot;</span>
</pre></div></section></article></main><footer>Site proudly generated by <a href=http://jaspervdj.be/hakyll>Hakyll</a>.
All content is licensed under <a href=../LICENSE.txt>3-clause BSD license</a>.</footer>