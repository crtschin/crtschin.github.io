<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>(Non-)Functional Ramblings - Lazy-ing in My Pool</title>
        <link rel="stylesheet" href="../../css/main.css" />
        <link rel="stylesheet" href="../../css/pygments.css" />
        <link rel="stylesheet" href="../../css/katex.css">
        <link rel="stylesheet" href="../../css/fonts.css">
        <link rel="shortcut icon" href="favicon.ico" type="image/x-icon"><link rel="shortcut icon" href="../../images/favicons/favicon32.png"><link rel="apple-touch-icon-precomposed" sizes="144x144" href="../../images/favicons/favicon144.png"><link rel="apple-touch-icon-precomposed" sizes="114x114" href="../../images/favicons/favicon114.png"><link rel="apple-touch-icon-precomposed" sizes="72x72" href="../../images/favicons/favicon72.png"><link rel="apple-touch-icon-precomposed" sizes="57x57" href="../../images/favicons/favicon57.png">
    </head>
    <body>
        <header>
            <nav class="header">
                <a class="logo" href="../../">Non-Functional Ramblings</a>
                <div class="navigation">
                    <a href="../../about.html">About</a>
                    <a href="../../static/resume.pdf">Resume</a>
                    <a href="../../archive.html">Archive</a>
                    <a href="../../atom.xml">Feed</a>
                </div>
            </nav>
        </header>

        <main role="main">
            <h1 class="title">Lazy-ing in My Pool</h1>
            <article>
    <section class="publish-date">
        Posted on October  1, 2024
        
    </section>
    <section>
        <p></p>
I encountered an interesting problem recently, where I needed to initialize a pool of resources. The caveat here is though, for performance reasons, I only wanted to initialize resources on demand, to avoid paying the price of initializing the entire pool when I might only need to do a singular action using one resource.
<p></p>
Imagine some usecase where we might have a pool of files we need to read over the network and some work we intend to do on each file contents. This <code>FileHandle</code> is the resource we’ll manually manage.
<div class="highlight"><pre><span></span><span class="kr">data</span><span class="w"> </span><span class="kt">FileHandle</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">FileHandle</span><span class="w"> </span><span class="p">{</span><span class="o">...</span><span class="p">}</span>

<span class="nf">doWork</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">FileHandle</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">IO</span><span class="w"> </span><span class="kt">Int</span>
<span class="nf">doWork</span><span class="w"> </span><span class="n">fileHandle</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">readArguments</span><span class="w"> </span><span class="n">fileHandle</span><span class="w"> </span><span class="o">&gt;&gt;=</span><span class="w"> </span><span class="n">process</span>
</pre></div>

<h2 id="explicit-lazy-resources">Explicit Lazy Resources</h2>
<p></p>
I’ll start with initializing a single resource lazily and only afterwards create a pool from there. Doing anything with resources implies using something like <code>bracket</code> to ensure finalization in the presence of exceptions. Though <code>bracket</code> isn’t enough by itself in this case, as <code>bracket</code> implies strict usage of the resource. What we can do, however, is create an explicitly lazy wrapper around initializing our resources and use that within bracket instead.
<div class="highlight"><pre><span></span><span class="kr">data</span><span class="w"> </span><span class="kt">LazyResource</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="n">a</span>
<span class="w">    </span><span class="ow">=</span><span class="w"> </span><span class="kt">Uninitialized</span><span class="w"> </span><span class="p">(</span><span class="n">m</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="kt">Initialized</span><span class="w"> </span><span class="n">a</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="kt">Finalized</span>
</pre></div>

<p></p>
We’ll need something extra to maintain what state the resource currently exists in, however. We could do something <code>State</code>-style and do <code>LazyResource a -&gt; (LazyResource a, r)</code>, but while concrete, that’s not very user friendly, and also not threadsafe. Alternatively, we could wrap the lazy wrapper and persist the resource’s state in an <code>MVar</code> cell.
<div class="highlight"><pre><span></span><span class="c1">-- | Anytime we use the resource, we trigger the deferred the initialization.</span>
<span class="nf">withLazyResource</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">MVar</span><span class="w"> </span><span class="p">(</span><span class="kt">LazyResource</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">IO</span><span class="w"> </span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">IO</span><span class="w"> </span><span class="n">r</span>
<span class="nf">withLazyResource</span><span class="w"> </span><span class="n">lazyResourceRef</span><span class="w"> </span><span class="n">continuation</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">mask</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="nf">\</span><span class="n">restore</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kr">do</span>
<span class="w">  </span><span class="n">lazyResource</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="n">takeMVar</span><span class="w"> </span><span class="n">lazyResourceRef</span>
<span class="w">  </span><span class="c1">-- We always have to ensure we put back the resource into the cell, to ensure</span>
<span class="w">  </span><span class="c1">-- any waiting, are unblocked</span>
<span class="w">  </span><span class="kr">let</span><span class="w"> </span><span class="n">putBackVerbatim</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">putMVar</span><span class="w"> </span><span class="n">lazyResourceRef</span><span class="w"> </span><span class="n">lazyResource</span>
<span class="w">  </span><span class="n">resource</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="kr">case</span><span class="w"> </span><span class="n">lazyResource</span><span class="w"> </span><span class="kr">of</span>
<span class="w">    </span><span class="kt">Uninitialized</span><span class="w"> </span><span class="n">initializer</span><span class="w"> </span><span class="ow">-&gt;</span>
<span class="w">      </span><span class="n">restore</span><span class="w"> </span><span class="n">initializer</span><span class="w"> </span><span class="p">`</span><span class="n">onException</span><span class="p">`</span><span class="w"> </span><span class="n">putBackVerbatim</span>
<span class="w">    </span><span class="kt">Initialized</span><span class="w"> </span><span class="n">resource</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">pure</span><span class="w"> </span><span class="n">resource</span>
<span class="w">    </span><span class="kt">Finalized</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kr">do</span>
<span class="w">      </span><span class="n">putBackVerbatim</span>
<span class="w">      </span><span class="ne">error</span><span class="w"> </span><span class="s">&quot;Attempted to use a resource after it has been finalized&quot;</span>

<span class="w">  </span><span class="c1">-- Same as the above, but we've now initialized the resource.</span>
<span class="w">  </span><span class="kr">let</span><span class="w"> </span><span class="n">putInitialized</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">putMVar</span><span class="w"> </span><span class="n">lazyResourceRef</span><span class="w"> </span><span class="p">(</span><span class="kt">Initialized</span><span class="w"> </span><span class="n">resource</span><span class="p">)</span>
<span class="w">  </span><span class="n">result</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="n">restore</span><span class="w"> </span><span class="p">(</span><span class="n">continuation</span><span class="w"> </span><span class="n">resource</span><span class="p">)</span><span class="w"> </span><span class="p">`</span><span class="n">onException</span><span class="p">`</span><span class="w"> </span><span class="n">putInitialized</span>
<span class="w">  </span><span class="n">putInitialized</span>
<span class="w">  </span><span class="n">pure</span><span class="w"> </span><span class="n">result</span>
</pre></div>

<p></p>
Some care has to be taken when exceptions are involved, and to ensure that the <code>MVar</code> is never left empty, even while initializing the resource in the first place! It is preferable that every thread depending on the resource fails, instead of being deadlocked on the thread that held the resource and died.
<p></p>
Creating one of these <code>MVar (LazyResource FileHandle)</code> is left as an exercise to the reader. It should take care of deferring both the initialization as well as finalization of the underlying resource, if needed.
<h2 id="lazy-pools">Lazy Pools</h2>
<p></p>
Creating pools of these lazy resources is not much different than pools of any manually managed resources, ensuring that each initialization is paired with a corresponding finalization. In actuality, you’ll likely want something that already exists like <a href="https://hackage.haskell.org/package/resource-pool">resource-pool</a>. But I’ll show a small simple alternative.
<p></p>
Keeping it simple, I’ll keep track of all resources in the pool in a simple list, along with a quantity semaphore that ensures we don’t exceed the intended number of resources.
<div class="highlight"><pre><span></span><span class="kr">data</span><span class="w"> </span><span class="kt">Pool</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Pool</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="n">resources</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">IORef</span><span class="w"> </span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
<span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">occupancy</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">QSem</span>
<span class="w">  </span><span class="p">}</span>
</pre></div>

<p></p>
For nesting consecutive <code>with</code>-like functions, there’s a neat trick you can do with <code>kan-extensions</code>’ <code>Codensity</code> wrapper.
<div class="highlight"><pre><span></span><span class="nf">withPool</span>
<span class="w">  </span><span class="ow">::</span><span class="w"> </span><span class="p">(</span><span class="n">forall</span><span class="w"> </span><span class="n">r</span><span class="o">.</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">IO</span><span class="w"> </span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">IO</span><span class="w"> </span><span class="n">r</span><span class="p">)</span>
<span class="w">  </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Int</span>
<span class="w">  </span><span class="ow">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="kt">Pool</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">IO</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">  </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">IO</span><span class="w"> </span><span class="n">b</span>
<span class="nf">withPool</span><span class="w"> </span><span class="n">withResource</span><span class="w"> </span><span class="n">poolSize</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">do</span>
<span class="w">  </span><span class="kr">let</span><span class="w"> </span><span class="n">withPoolResources</span><span class="w"> </span><span class="ow">=</span>
<span class="w">        </span><span class="n">runCodensity</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">replicateM</span><span class="w"> </span><span class="n">poolSize</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kt">Codensity</span><span class="w"> </span><span class="n">withResource</span>

<span class="w">  </span><span class="n">withPoolResources</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="nf">\</span><span class="n">resources</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kr">do</span>
<span class="w">    </span><span class="n">poolResources</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="n">newIORef</span><span class="w"> </span><span class="n">resources</span>
<span class="w">    </span><span class="n">qSem</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="n">newQSem</span><span class="w"> </span><span class="n">poolSize</span>
<span class="w">    </span><span class="n">action</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kt">Pool</span><span class="w"> </span><span class="n">poolResources</span><span class="w"> </span><span class="n">qSem</span>
</pre></div>

<p></p>
That’s it! Using the pool is should be straightforward, keeping the resources in the pool and the semaphore in sync, while masking exceptions via <code>bracket</code>. And it can be combined with <code>withLazyResource</code> to handle lazy resources transparently.
    </section>
</article>

        </main>

        <footer>
            Site proudly generated by <a href="http://jaspervdj.be/hakyll">Hakyll</a>.
            All content is licensed under <a href="../../license.txt">3-clause BSD license</a>.
        </footer>
    </body>
</html>
